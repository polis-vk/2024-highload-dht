Свою работу по анализу изменений в нашей асинхронной версии я начала с определения оптимальных параметров для размера пула и очереди, чтобы уже для них определять выдерживаемую нагрузку.

Оптимальное отношение данных величин я подбирала путем нагрочного тестирования GET-запросов. 

При постепенном увеличении размера пула задержка 99 персентиля незначительно увеличивалась, для дальнейшего тестирования было выбрано значение в 32 потока. 
Такая же операция была проведена для определения подходящего значения очереди. 
Удалось выяснить, что при размерах очереди, меньших размера пула и сильно больше, сервер начинали не выдерживать всю направляемую на него нагрузку, фиксируя Socket errors.
Для дальнейшего тестирования была зафиксирована очередь размером 128. 

Следующим шагом мне хотелось определить, какую же нагрузку может тянуть наш асинхронный сервер. 
Постепенно увеличивая подаваемые RPS и отправляя запросы в 64 соединия, я получила следующие результаты 

GET 50000
50.000%    2.18ms
75.000%    2.90ms
90.000%    3.59ms
99.000%    5.00ms
99.900%    6.29ms
99.990%    7.01ms
99.999%    8.05ms
100.000%    8.93ms

GET 70000
50.000%   17.41ms
75.000%   33.53ms
90.000%   44.99ms
99.000%   60.35ms
99.900%   67.39ms
99.990%   71.30ms
99.999%   73.09ms
100.000%   73.92ms

GET 85000 - тут можно заметить точку разладки
50.000%    1.16s
75.000%    1.48s
90.000%    1.59s
99.000%    1.72s
99.900%    1.76s
99.990%    1.79s
99.999%    1.80s
100.000%    1.80s

Для PUT запросов, так как вставка по определению работает быстрее для LSM, точкой разладки стало значение в 100K RPS
PUT 100000
50.000%    3.14s
75.000%    3.72s
90.000%    4.01s
99.000%    4.12s
99.900%    4.17s
99.990%    4.20s
99.999%    4.20s
100.000%    4.21s

Затем необходимо было понять, каким образом выбор типа очереди влияет на выдерживаемую нагрузку.
Я сравнила два варианта - с использованием ArrayBlockingQueue и LinkedBlockingQueue.
Предполагала, что из-за того, что LinkedBlockingQueue - связанный список и при каждой вставке происходит динамическое создание узлов, она по показателям будет проигрывать ArrayBlockingQueue. 
Так и получилось, задержка при стабильной нагрузку с использованием ArrayBlockingQueue оказалась чуть меньше.

Latency     2.37ms    1.12ms   7.68ms   68.17% - ArrayBlockingQueue
Latency     2.45ms    1.17ms   9.40ms   68.45% - LinkedBlockingQueue

Стабильно нагружая сервер PUT-запросами в течение минуты получила следуюшие персентили:

50.000%    1.65ms
75.000%    2.22ms
90.000%    2.75ms
99.000%   27.39ms
99.900%   68.67ms
99.990%   87.23ms
99.999%   88.64ms
100.000%   88.89ms

Detailed Percentile spectrum:
Value   Percentile   TotalCount 1/(1-Percentile)

       0.027     0.000000            1         1.00
       0.704     0.100000       248928         1.11
       0.993     0.200000       497262         1.25
       1.230     0.300000       745243         1.43
       1.446     0.400000       993941         1.67
       1.654     0.500000      1243005         2.00
       1.759     0.550000      1366977         2.22
       1.865     0.600000      1490854         2.50
       1.976     0.650000      1615655         2.86
       2.093     0.700000      1739957         3.33
       2.219     0.750000      1863974         4.00
       2.287     0.775000      1925837         4.44
       2.361     0.800000      1988735         5.00
       2.439     0.825000      2049715         5.71
       2.527     0.850000      2111747         6.67
       2.627     0.875000      2174167         8.00
       2.683     0.887500      2205148         8.89
       2.745     0.900000      2236545        10.00
       2.813     0.912500      2267122        11.43
       2.891     0.925000      2297874        13.33
       2.985     0.937500      2328767        16.00
       3.043     0.943750      2344653        17.78
       3.107     0.950000      2360054        20.00
       3.185     0.956250      2375673        22.86
       3.281     0.962500      2390895        26.67
       3.419     0.968750      2406487        32.00
       3.519     0.971875      2414227        35.56
       3.673     0.975000      2421950        40.00
       3.989     0.978125      2429693        45.71
       5.803     0.981250      2437441        53.33
      12.671     0.984375      2445202        64.00
      16.159     0.985938      2449084        71.11
      20.607     0.987500      2452963        80.00
      24.895     0.989062      2456849        91.43
      29.391     0.990625      2460729       106.67
      34.079     0.992188      2464624       128.00
      36.159     0.992969      2466563       142.22
      38.559     0.993750      2468491       160.00
      41.695     0.994531      2470442       182.86
      45.599     0.995313      2472385       213.33
      51.167     0.996094      2474311       256.00
      53.759     0.996484      2475280       284.44
      56.159     0.996875      2476267       320.00
      58.335     0.997266      2477231       365.71
      60.351     0.997656      2478207       426.67
      61.951     0.998047      2479164       512.00
      62.719     0.998242      2479654       568.89
      63.583     0.998437      2480148       640.00
      64.543     0.998633      2480618       731.43
      65.791     0.998828      2481111       853.33
      69.247     0.999023      2481589      1024.00
      70.911     0.999121      2481832      1137.78
      72.959     0.999219      2482080      1280.00
      76.031     0.999316      2482314      1462.86
      79.167     0.999414      2482562      1706.67
      81.727     0.999512      2482812      2048.00
      82.559     0.999561      2482928      2275.56
      83.263     0.999609      2483043      2560.00
      84.031     0.999658      2483169      2925.71
      84.799     0.999707      2483285      3413.33
      85.567     0.999756      2483416      4096.00
      85.823     0.999780      2483470      4551.11
      86.143     0.999805      2483537      5120.00
      86.463     0.999829      2483599      5851.43
      86.719     0.999854      2483655      6826.67
      86.911     0.999878      2483711      8192.00
      87.103     0.999890      2483741      9102.22
      87.295     0.999902      2483775     10240.00
      87.487     0.999915      2483812     11702.86
      87.615     0.999927      2483844     13653.33
      87.743     0.999939      2483870     16384.00
      87.807     0.999945      2483879     18204.44
      87.871     0.999951      2483891     20480.00
      87.999     0.999957      2483909     23405.71
      88.127     0.999963      2483923     27306.67
      88.255     0.999969      2483940     32768.00
      88.319     0.999973      2483944     36408.89
      88.383     0.999976      2483952     40960.00
      88.447     0.999979      2483963     46811.43
      88.511     0.999982      2483973     54613.33
      88.575     0.999985      2483983     65536.00
      88.575     0.999986      2483983     72817.78
      88.575     0.999988      2483983     81920.00
      88.639     0.999989      2483990     93622.86
      88.639     0.999991      2483990    109226.67
      88.703     0.999992      2483998    131072.00
      88.703     0.999993      2483998    145635.56
      88.703     0.999994      2483998    163840.00
      88.767     0.999995      2484007    187245.71
      88.767     0.999995      2484007    218453.33
      88.767     0.999996      2484007    262144.00
      88.767     0.999997      2484007    291271.11
      88.767     0.999997      2484007    327680.00
      88.767     0.999997      2484007    374491.43
      88.767     0.999998      2484007    436906.67
      88.831     0.999998      2484009    524288.00
      88.831     0.999998      2484009    582542.22
      88.831     0.999998      2484009    655360.00
      88.831     0.999999      2484009    748982.86
      88.895     0.999999      2484012    873813.33
      88.895     1.000000      2484012          inf


Обращаясь к результатам профилирования, следует отметить

CPU PUT/GET

Теперь ресурсы процессора трятятся на работу с очередью, вызов ArrayBlockingQueue take() чтобы получить задачу на исполнение занимает (~15%).  

ALLOC PUT/GET

Профиль аллокаций в целом не поменялся, лищь добавились аллокации, связанные с работой с очередью

LOCK PUT/GET

По профилю блокировок можно увидеть, что основное время уходит на взятие блокировки при взятии задачи из пула и ее
добавлении туда

И совсем немного уходит на то, чтобы взять блокировку для записи в сессию


