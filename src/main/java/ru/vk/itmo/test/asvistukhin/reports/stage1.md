## Нагрузочное тестирование

### PUT 5000 RPS
```
Running 2m test @ http://localhost:8080/v0/entity
1 threads and 1 connections
Thread calibration: mean lat.: 1.043ms, rate sampling interval: 10ms
Thread Stats   Avg      Stdev     Max   +/- Stdev
Latency     1.00ms  540.41us   7.30ms   59.29%
Req/Sec     5.30k   368.94     8.50k    66.67%
Latency Distribution (HdrHistogram - Recorded Latency)
50.000%    1.00ms
75.000%    1.45ms
90.000%    1.76ms
99.000%    1.95ms
99.900%    2.10ms
99.990%    3.51ms
99.999%    6.62ms
100.000%    7.30ms

    Detailed Percentile spectrum:

        Value   Percentile   TotalCount 1/(1-Percentile)
        0.015     0.000000            1         1.00
        0.238     0.100000        55049         1.11
        0.452     0.200000       110163         1.25
        0.666     0.300000       165068         1.43
        0.879     0.400000       220212         1.67
        0.997     0.500000       275173         2.00
        1.052     0.550000       302521         2.22
        1.128     0.600000       330060         2.50
        1.235     0.650000       357632         2.86
        1.338     0.700000       385081         3.33
        1.446     0.750000       412636         4.00
        1.498     0.775000       426506         4.44
        1.550     0.800000       440052         5.00
        1.604     0.825000       453897         5.71
        1.655     0.850000       467662         6.67
        1.706     0.875000       481428         8.00
        1.732     0.887500       488127         8.89
        1.760     0.900000       495095        10.00
        1.785     0.912500       501914        11.43
        1.810     0.925000       508809        13.33
        1.837     0.937500       515862        16.00
        1.849     0.943750       519053        17.78
        1.862     0.950000       522590        20.00
        1.874     0.956250       525973        22.86
        1.888     0.962500       529591        26.67
        1.901     0.968750       532817        32.00
        1.908     0.971875       534583        35.56
        1.915     0.975000       536378        40.00
        1.922     0.978125       538092        45.71
        1.929     0.981250       539801        53.33
        1.936     0.984375       541623        64.00
        1.939     0.985938       542404        71.11
        1.942     0.987500       543164        80.00
        1.945     0.989062       543974        91.43
        1.949     0.990625       544898       106.67
        1.953     0.992188       545808       128.00
        1.955     0.992969       546177       142.22
        1.958     0.993750       546624       160.00
        1.962     0.994531       547065       182.86
        1.967     0.995313       547436       213.33
        1.975     0.996094       547854       256.00
        1.981     0.996484       548066       284.44
        1.988     0.996875       548265       320.00
        1.999     0.997266       548489       365.71
        2.012     0.997656       548700       426.67
        2.030     0.998047       548913       512.00
        2.042     0.998242       549022       568.89
        2.055     0.998437       549122       640.00
        2.069     0.998633       549232       731.43
        2.083     0.998828       549339       853.33
        2.105     0.999023       549445      1024.00
        2.117     0.999121       549502      1137.78
        2.129     0.999219       549554      1280.00
        2.141     0.999316       549612      1462.86
        2.159     0.999414       549668      1706.67
        2.183     0.999512       549714      2048.00
        2.203     0.999561       549740      2275.56
        2.229     0.999609       549768      2560.00
        2.249     0.999658       549796      2925.71
        2.289     0.999707       549822      3413.33
        2.373     0.999756       549847      4096.00
        2.437     0.999780       549861      4551.11
        2.585     0.999805       549874      5120.00
        2.765     0.999829       549888      5851.43
        2.943     0.999854       549901      6826.67
        3.235     0.999878       549914      8192.00
        3.409     0.999890       549921      9102.22
        3.521     0.999902       549928     10240.00
        3.685     0.999915       549935     11702.86
        3.833     0.999927       549941     13653.33
        3.965     0.999939       549948     16384.00
        4.033     0.999945       549951     18204.44
        4.175     0.999951       549955     20480.00
        4.367     0.999957       549958     23405.71
        4.563     0.999963       549961     27306.67
        5.123     0.999969       549965     32768.00
        5.263     0.999973       549966     36408.89
        5.563     0.999976       549968     40960.00
        5.843     0.999979       549970     46811.43
        5.995     0.999982       549971     54613.33
        6.275     0.999985       549973     65536.00
        6.419     0.999986       549974     72817.78
        6.499     0.999988       549975     81920.00
        6.619     0.999989       549976     93622.86
        6.619     0.999991       549976    109226.67
        6.755     0.999992       549977    131072.00
        6.911     0.999993       549978    145635.56
        6.911     0.999994       549978    163840.00
        7.051     0.999995       549979    187245.71
        7.051     0.999995       549979    218453.33
        7.051     0.999996       549979    262144.00
        7.191     0.999997       549980    291271.11
        7.191     0.999997       549980    327680.00
        7.191     0.999997       549980    374491.43
        7.191     0.999998       549980    436906.67
        7.191     0.999998       549980    524288.00
        7.303     0.999998       549981    582542.22
        7.303     1.000000       549981          inf
        #[Mean    =        1.001, StdDeviation   =        0.540]
        #[Max     =        7.300, Total count    =       549981]
        #[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
599998 requests in 2.00m, 38.34MB read
Requests/sec:   4999.96
Transfer/sec:    327.15KB
```
### async-profiler
#### CPU
С помощью профилировщика можно увидеть, что 
- 11% процессорного времени занимало сохранение SSTable на диск
- 32% времени ушло на отправку запроса клиенту (write one-nio)
- 8% времени на вставку записи в in-memory SSTable
- 14% на обработку запроса от клиента (read one-nio)
- 18% времени ушло на компиляцию более оптимизированного кода (С2 compiler)

При сохранении на диск, почти всё время занимало непосредственно само сохранение, малую часть времени
съедали операции с MemorySegment (copy, set). Возможно, есть смысл поиграться с параметром threshold 
на размер SSTable для выгрузки на диск.

При вставке в SSTable, практически 1/3 времени съел comparator. Возможно, стоило бы посмотреть, нельзя ли его 
оптимизировать, так как для операции вставки, это кажется, дороговато.

#### ALLOC
- 38% памяти выделяется под операции сохранения SSTable на диск. Из которых 28% уходит на чтение индекс файла
- 22% памяти уходит на upsert, из них 12% на операции перевода из String в MemorySegment (методы ofArray, getBytes),
3% на сохранение в SSTable, остальное на создание ответа one-nio.
- 39% уходит под операции парсинга запроса, создание ответа one-nio.

Кажется, стоило бы подумать над оптимизацией чтения файла индекса, либо вообще изменения логики в этом месте кода,
потому что 1/4 аллокаций на чтение файла - too much. Также, имеет смысл подумать над тем, как сохраняются файлы в БД.
Наверное, есть способ улучшить перевод строкового типа в MemorySegment. Возможно, для каких-нибудь целей, мы могли бы уйти от MemorySegment и сохранять, допустим, в строках либо наборе примитивных типов.


### GET 500 RPS

```
Running 1m test @ http://localhost:8080/v0/entity
  1 threads and 1 connections
  Thread calibration: mean lat.: 2.728ms, rate sampling interval: 10ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     2.40ms  746.21us   9.94ms   84.42%
    Req/Sec   526.43     67.60   666.00     65.99%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    2.29ms
 75.000%    2.63ms
 90.000%    3.03ms
 99.000%    5.34ms
 99.900%    8.55ms
 99.990%    9.80ms
 99.999%    9.94ms
100.000%    9.94ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       1.203     0.000000            1         1.00
       1.717     0.100000         2506         1.11
       1.881     0.200000         5020         1.25
       2.019     0.300000         7502         1.43
       2.159     0.400000        10028         1.67
       2.289     0.500000        12519         2.00
       2.355     0.550000        13787         2.22
       2.417     0.600000        15032         2.50
       2.479     0.650000        16258         2.86
       2.551     0.700000        17529         3.33
       2.627     0.750000        18778         4.00
       2.667     0.775000        19376         4.44
       2.713     0.800000        20022         5.00
       2.763     0.825000        20624         5.71
       2.825     0.850000        21266         6.67
       2.905     0.875000        21876         8.00
       2.963     0.887500        22186         8.89
       3.031     0.900000        22500        10.00
       3.135     0.912500        22812        11.43
       3.275     0.925000        23127        13.33
       3.431     0.937500        23437        16.00
       3.531     0.943750        23594        17.78
       3.651     0.950000        23750        20.00
       3.797     0.956250        23909        22.86
       3.945     0.962500        24061        26.67
       4.151     0.968750        24218        32.00
       4.271     0.971875        24296        35.56
       4.371     0.975000        24375        40.00
       4.523     0.978125        24454        45.71
       4.703     0.981250        24531        53.33
       4.903     0.984375        24611        64.00
       4.979     0.985938        24647        71.11
       5.063     0.987500        24686        80.00
       5.243     0.989062        24725        91.43
       5.411     0.990625        24765       106.67
       5.615     0.992188        24803       128.00
       5.779     0.992969        24824       142.22
       5.935     0.993750        24842       160.00
       6.127     0.994531        24863       182.86
       6.339     0.995313        24882       213.33
       6.731     0.996094        24901       256.00
       7.007     0.996484        24912       284.44
       7.287     0.996875        24920       320.00
       7.511     0.997266        24930       365.71
       7.719     0.997656        24940       426.67
       7.999     0.998047        24950       512.00
       8.087     0.998242        24955       568.89
       8.187     0.998437        24959       640.00
       8.287     0.998633        24964       731.43
       8.463     0.998828        24969       853.33
       8.551     0.999023        24975      1024.00
       8.655     0.999121        24977      1137.78
       8.703     0.999219        24979      1280.00
       8.911     0.999316        24981      1462.86
       9.183     0.999414        24984      1706.67
       9.263     0.999512        24986      2048.00
       9.439     0.999561        24988      2275.56
       9.503     0.999609        24989      2560.00
       9.591     0.999658        24990      2925.71
       9.599     0.999707        24991      3413.33
       9.663     0.999756        24992      4096.00
       9.671     0.999780        24993      4551.11
       9.703     0.999805        24994      5120.00
       9.703     0.999829        24994      5851.43
       9.767     0.999854        24995      6826.67
       9.767     0.999878        24995      8192.00
       9.799     0.999890        24996      9102.22
       9.799     0.999902        24996     10240.00
       9.799     0.999915        24996     11702.86
       9.919     0.999927        24997     13653.33
       9.919     0.999939        24997     16384.00
       9.919     0.999945        24997     18204.44
       9.919     0.999951        24997     20480.00
       9.919     0.999957        24997     23405.71
       9.943     0.999963        24998     27306.67
       9.943     1.000000        24998          inf
#[Mean    =        2.398, StdDeviation   =        0.746]
#[Max     =        9.936, Total count    =        24998]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  30001 requests in 1.00m, 3.38MB read
Requests/sec:    500.00
Transfer/sec:     57.61KB
```
### async-profiler
#### CPU
- 15% времени уходит на создание списка итераторов для операции get
- 79% времени на метод MemorySegmentUtils.indexOf(). Из которых 43% занимает 
MemorySegment.mismatch(), 13% MemorySegment.get(), 14% MemorySegmentUtils.recordsCount()
- 0.5% занимал garbage collector
- 0.6% занимали операции one-nio по парсингу запроса и возврату ответа

Здесь ситуация совсем печальная, бинарный поиск по SSTable на диске убивает всю производительность. Из-за этого
система очень проседает в запросах на GET. Если обращаться к "горячим" записям - производительность будет хорошая,
но когда БД начинает перекапывать диск - всё очень проседает. Это критический bottle-neck в системе, обязательно нужно
переписывать логику взаимодействия с файлами на диске и поиска записей.
Логика итераторов должна быть переписана.

#### ALLOC
- 99.7% аллоков уходит на операции с взятием записи из диска. Это настолько большой показатель,
что я даже не могу прокликать остальные 0.3%, чтобы посмотреть, что было там. Подозреваю,
что это операции one-nio по парсингу запроса и формированию ответа.

43% уходило на получение следующего элемента из SSTable на диске, в основном там тяжелые операции с duplicate и asSlice MemorySegment. Также, 3% уходит на
получение списка всех SSTable на диске (в виде списка файлов). 40% уходило на создание итератора по SSTable.


### Выводы
Система неплохо работает только на запись, на чтение очень медленно. Чтобы улучшить ситуацию, необходимо переписать логику
сохранения файлов на диск, чтение из диска, поиск записи из диска по SSTable - это критично. Также, можно было бы оптимизировать
comparator, и способ перевода строк в MemorySegment (если это возможно).
Также, во время первых проверок профилировщика, я заметил, что значительная часть времени (~6%) уходила на создание стектрейса исключения,
связанного с тем, что файл в системе уже существует. Я переписал эту логику, и больше в профилировщике не видел, чтобы стектрейс подъедал
процессорное время.


P.S. можно ли в следующей лабораторной работе взять референс, чтобы не переписывать во время этих лабораторных мою реализацию?

##### Результаты
Посмотреть результаты async-profiler: src/main/java/ru/vk/itmo/test/asvistukhin/reports/async_profiler

Скрипты для генерации wrk запросов: src/main/java/ru/vk/itmo/test/asvistukhin/reports/wrk_script