## Нагрузочное тестирование
Тестирование проводил на одной машине в одной среде. Сервер и wrk/async запускались рядом.
JVM была прогрета запросами.

### PUT 40000 RPS.
Если RPS делать выше - сервис начинает быстро просаживаться в скорости ответа, доходит к секундам.
```
Running 1m test @ http://localhost:8080/v0/entity
  1 threads and 64 connections
  Thread calibration: mean lat.: 2.115ms, rate sampling interval: 10ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     2.93ms    7.87ms 148.74ms   95.83%
    Req/Sec    42.29k     6.58k   66.33k    82.88%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    1.52ms
 75.000%    1.96ms
 90.000%    3.53ms
 99.000%   30.14ms
 99.900%  113.92ms
 99.990%  134.01ms
 99.999%  145.41ms
100.000%  148.86ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.032     0.000000            2         1.00
       0.857     0.100000       238981         1.11
       1.069     0.200000       478535         1.25
       1.225     0.300000       716554         1.43
       1.374     0.400000       956280         1.67
       1.520     0.500000      1194492         2.00
       1.595     0.550000      1314158         2.22
       1.673     0.600000      1433547         2.50
       1.756     0.650000      1552028         2.86
       1.850     0.700000      1671179         3.33
       1.961     0.750000      1790529         4.00
       2.026     0.775000      1850266         4.44
       2.101     0.800000      1910365         5.00
       2.195     0.825000      1969828         5.71
       2.347     0.850000      2029452         6.67
       2.639     0.875000      2088864         8.00
       2.931     0.887500      2118721         8.89
       3.525     0.900000      2148525        10.00
       4.871     0.912500      2178323        11.43
       6.363     0.925000      2208170        13.33
       7.675     0.937500      2238006        16.00
       8.383     0.943750      2253027        17.78
       9.231     0.950000      2267909        20.00
      10.375     0.956250      2282773        22.86
      11.847     0.962500      2297743        26.67
      13.575     0.968750      2312646        32.00
      14.567     0.971875      2320119        35.56
      15.591     0.975000      2327541        40.00
      16.799     0.978125      2335003        45.71
      18.511     0.981250      2342451        53.33
      21.199     0.984375      2349909        64.00
      23.135     0.985938      2353639        71.11
      25.423     0.987500      2357372        80.00
      28.207     0.989062      2361096        91.43
      31.615     0.990625      2364839       106.67
      38.047     0.992188      2368576       128.00
      40.543     0.992969      2370422       142.22
      47.519     0.993750      2372284       160.00
      56.383     0.994531      2374146       182.86
      66.303     0.995313      2376011       213.33
      76.287     0.996094      2377879       256.00
      81.663     0.996484      2378814       284.44
      87.039     0.996875      2379750       320.00
      92.543     0.997266      2380682       365.71
      97.855     0.997656      2381620       426.67
     102.783     0.998047      2382552       512.00
     105.215     0.998242      2383012       568.89
     107.519     0.998437      2383473       640.00
     109.823     0.998633      2383948       731.43
     111.935     0.998828      2384404       853.33
     114.175     0.999023      2384879      1024.00
     115.199     0.999121      2385109      1137.78
     116.159     0.999219      2385336      1280.00
     116.991     0.999316      2385582      1462.86
     117.823     0.999414      2385808      1706.67
     118.527     0.999512      2386040      2048.00
     119.103     0.999561      2386154      2275.56
     119.743     0.999609      2386284      2560.00
     120.127     0.999658      2386395      2925.71
     121.023     0.999707      2386508      3413.33
     121.983     0.999756      2386625      4096.00
     123.135     0.999780      2386679      4551.11
     125.503     0.999805      2386735      5120.00
     127.807     0.999829      2386797      5851.43
     129.983     0.999854      2386852      6826.67
     132.095     0.999878      2386910      8192.00
     133.503     0.999890      2386945      9102.22
     134.271     0.999902      2386970     10240.00
     135.295     0.999915      2387000     11702.86
     136.319     0.999927      2387029     13653.33
     137.343     0.999939      2387057     16384.00
     138.111     0.999945      2387071     18204.44
     138.623     0.999951      2387086     20480.00
     139.135     0.999957      2387100     23405.71
     139.903     0.999963      2387115     27306.67
     140.799     0.999969      2387133     32768.00
     141.311     0.999973      2387139     36408.89
     141.695     0.999976      2387143     40960.00
     142.335     0.999979      2387151     46811.43
     142.847     0.999982      2387158     54613.33
     143.871     0.999985      2387167     65536.00
     144.383     0.999986      2387170     72817.78
     144.767     0.999988      2387173     81920.00
     145.279     0.999989      2387176     93622.86
     145.663     0.999991      2387180    109226.67
     146.047     0.999992      2387183    131072.00
     146.431     0.999993      2387186    145635.56
     146.943     0.999994      2387189    163840.00
     146.943     0.999995      2387189    187245.71
     147.455     0.999995      2387192    218453.33
     147.455     0.999996      2387192    262144.00
     147.583     0.999997      2387193    291271.11
     147.839     0.999997      2387194    327680.00
     147.967     0.999997      2387195    374491.43
     148.095     0.999998      2387196    436906.67
     148.351     0.999998      2387197    524288.00
     148.351     0.999998      2387197    582542.22
     148.479     0.999998      2387199    655360.00
     148.479     0.999999      2387199    748982.86
     148.479     0.999999      2387199    873813.33
     148.479     0.999999      2387199   1048576.00
     148.479     0.999999      2387199   1165084.44
     148.863     0.999999      2387201   1310720.00
     148.863     1.000000      2387201          inf
#[Mean    =        2.934, StdDeviation   =        7.875]
#[Max     =      148.736, Total count    =      2387201]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  2759997 requests in 1.17m, 176.35MB read
Requests/sec:  39428.11
Transfer/sec:      2.52MB
```
### async-profiler
#### CPU
С помощью профилировщика можно увидеть, что
- 30% времени на отправку запроса клиенту (write one-nio, из них 25% съел сам syscall)
- 18% времени на взятие задачи из очереди, а именно метод ArrayBlockingQueue.take() (больше всего времени ушло на lock/unlock)
- 19% на обработку запроса от клиента (read one-nio)
- 10% на сборщик мусора
- 8% времени на вставку записи в in-memory SSTable
- 8% времени на вставку задачи в очередь, также большую часть занимали lock/unlock

Сервер стал асинхронным, он начал выдерживать намного больше запросов (в моем случае в 8 раз). Теперь в профилировщике видно,
что бОльшую часть процессорного времени занимают либо чтение/запись в сокет, парсинг и прочие операции самого сервера. Также,
много времени занимает работа с очередью запросов. Из-за того, что структура должна быть thread-safe, внутри неё выполняется большое
количество lock/unlock, что забирает много процессорного времени.

#### ALLOC
- 31% памяти выделяется под операции upsert. Из которых 15% уходит на работу со строками и переводом в MemorySegment, 9% на формирование
ответа, и 3% на то, чтобы положить значение в сам SSTable.
- 22% уходит под операции чтения запроса (2% на выбор селектора, 20% на процессинг/парсинг запроса).
- 41% памяти процессинг самого запроса. 17% на операцию upsert, 10% на отправку ответа, 2% на выборку запроса из очереди

Я посмотрел в папку, в которой хранятся SSTables и увидел, что у меня каждая SSTable занимает всего по 6КБ, что очень мало.
Из-за этого на диске было огромное количество таблиц, и бинарный поиск просто тонул в этих таблицах. Я нашел, что в кассандре
таблицы хранятся в размере 5МБ и сделал также. Теперь секцию с сохранением на диск даже не видно, так как она не занимает памяти,
а раньше, она занимала под 1/3 аллокаций.


### GET 6000 RPS
Я поднял размер SSTable с 5КБ до 5МБ и скорость сразу выросла в 12 раз. До этого, даже с учетом асинхронного сервера,
он мог держать только 500 RPS. При повышении RPS, из-за того, что поиск по диску выполнялся очень долго, запросы просто забивали очередь, а потом и
вовсе отбивались по ошибке.

```
Running 1m test @ http://localhost:8080/v0/entity
  1 threads and 64 connections
  Thread calibration: mean lat.: 2.286ms, rate sampling interval: 10ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     1.98ms    1.21ms  46.24ms   81.53%
    Req/Sec     6.33k   579.03    11.33k    73.27%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    1.85ms
 75.000%    2.45ms
 90.000%    3.18ms
 99.000%    5.66ms
 99.900%   14.17ms
 99.990%   26.11ms
 99.999%   33.89ms
100.000%   46.27ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.118     0.000000            1         1.00
       0.818     0.100000        35877         1.11
       1.134     0.200000        71724         1.25
       1.397     0.300000       107490         1.43
       1.629     0.400000       143320         1.67
       1.850     0.500000       179114         2.00
       1.957     0.550000       197073         2.22
       2.065     0.600000       214997         2.50
       2.181     0.650000       232914         2.86
       2.307     0.700000       250673         3.33
       2.451     0.750000       268720         4.00
       2.531     0.775000       277678         4.44
       2.617     0.800000       286462         5.00
       2.721     0.825000       295476         5.71
       2.843     0.850000       304466         6.67
       2.989     0.875000       313318         8.00
       3.079     0.887500       317800         8.89
       3.177     0.900000       322281        10.00
       3.287     0.912500       326761        11.43
       3.409     0.925000       331223        13.33
       3.549     0.937500       335716        16.00
       3.625     0.943750       337987        17.78
       3.705     0.950000       340221        20.00
       3.793     0.956250       342417        22.86
       3.903     0.962500       344669        26.67
       4.055     0.968750       346900        32.00
       4.151     0.971875       348008        35.56
       4.267     0.975000       349130        40.00
       4.431     0.978125       350247        45.71
       4.639     0.981250       351363        53.33
       4.927     0.984375       352483        64.00
       5.099     0.985938       353043        71.11
       5.299     0.987500       353608        80.00
       5.515     0.989062       354166        91.43
       5.767     0.990625       354719       106.67
       6.147     0.992188       355280       128.00
       6.387     0.992969       355558       142.22
       6.679     0.993750       355838       160.00
       7.051     0.994531       356115       182.86
       7.543     0.995313       356395       213.33
       8.083     0.996094       356675       256.00
       8.439     0.996484       356816       284.44
       8.831     0.996875       356956       320.00
       9.407     0.997266       357094       365.71
      10.063     0.997656       357235       426.67
      10.815     0.998047       357374       512.00
      11.239     0.998242       357444       568.89
      11.711     0.998437       357514       640.00
      12.375     0.998633       357584       731.43
      13.223     0.998828       357654       853.33
      14.287     0.999023       357724      1024.00
      14.863     0.999121       357761      1137.78
      15.599     0.999219       357794      1280.00
      16.375     0.999316       357829      1462.86
      17.279     0.999414       357866      1706.67
      17.807     0.999512       357900      2048.00
      18.271     0.999561       357916      2275.56
      18.799     0.999609       357934      2560.00
      19.631     0.999658       357951      2925.71
      20.815     0.999707       357969      3413.33
      21.583     0.999756       357986      4096.00
      22.447     0.999780       357995      4551.11
      23.039     0.999805       358004      5120.00
      23.647     0.999829       358012      5851.43
      24.399     0.999854       358021      6826.67
      24.959     0.999878       358030      8192.00
      25.663     0.999890       358034      9102.22
      26.223     0.999902       358039     10240.00
      26.671     0.999915       358043     11702.86
      27.471     0.999927       358047     13653.33
      27.711     0.999939       358052     16384.00
      28.031     0.999945       358054     18204.44
      28.623     0.999951       358056     20480.00
      29.055     0.999957       358058     23405.71
      29.279     0.999963       358060     27306.67
      32.159     0.999969       358063     32768.00
      32.319     0.999973       358064     36408.89
      32.463     0.999976       358065     40960.00
      32.719     0.999979       358066     46811.43
      32.831     0.999982       358067     54613.33
      33.631     0.999985       358068     65536.00
      33.887     0.999986       358069     72817.78
      33.887     0.999988       358069     81920.00
      38.143     0.999989       358070     93622.86
      38.143     0.999991       358070    109226.67
      38.687     0.999992       358071    131072.00
      38.687     0.999993       358071    145635.56
      38.687     0.999994       358071    163840.00
      41.183     0.999995       358072    187245.71
      41.183     0.999995       358072    218453.33
      41.183     0.999996       358072    262144.00
      41.183     0.999997       358072    291271.11
      41.183     0.999997       358072    327680.00
      46.271     0.999997       358073    374491.43
      46.271     1.000000       358073          inf
#[Mean    =        1.983, StdDeviation   =        1.214]
#[Max     =       46.240, Total count    =       358073]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  419068 requests in 1.17m, 47.18MB read
Requests/sec:   5986.66
Transfer/sec:    690.18KB
```
### GET по рандомным ID
```
Running 1m test @ http://localhost:8080/v0/entity
  1 threads and 64 connections
  Thread calibration: mean lat.: 3.148ms, rate sampling interval: 10ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     2.23ms    2.84ms 144.38ms   97.73%
    Req/Sec     6.33k   620.43    15.90k    71.66%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    1.98ms
 75.000%    2.55ms
 90.000%    3.29ms
 99.000%    7.82ms
 99.900%   38.40ms
 99.990%   94.40ms
 99.999%  135.29ms
100.000%  144.51ms
```
Видно, что производительность +- такая же, как и в последовательном GET скрипте.
Наверное, на HDD здесь была бы огромная разница.

### async-profiler
#### CPU
- 59% времени на метод MemorySegmentUtils.indexOf(). Из которых 34% занимает MemorySegment.mismatch().
- 9% времени уходит на создание списка итераторов для операции get
- 8% времени на взятие задачи из очереди
- 6% времени на процессинг запроса (чтение/парсинг)
- 6% времени на отправку ответа
- 0.5% занимал garbage collector

По сравнению с первой лабораторной - ситуация стала получше. Из-за того, что изменил размер таблицы, теперь бинарный поиск
не тонет в тысячах сохраненных таблиц. Скорость операции чтения стала лучше, но всё равно участок кода отвечающий за поиск
entity на диске требует рефакторинга.

#### ALLOC
- 92% аллоков уходит на операции с взятием записи из диска. Из которых 53% MergeIterator съедает и 33% итератор по диску.
- 2% на процессинг запроса (чтение/парсинг)
- 1% на аллокацию памяти для очереди
- 1% на создание ответа


### Выводы
По сравнению с прошлой версией сервера, скорость записи и чтения значительно улучшились. В прошлой лабораторной работе упустил
проблему с маленьким размером таблиц, из-за того, что в этой исправил - операции чтения стали тоже лучше. Всё же, логика поиска записи
требует рефакторинга, потому что работает очень медленно. Также, нужно найти золотую середину в размере таблицы, так как если поставить
очень большую - операции записи начинают падать в производительности, если поставить очень маленькую - операции чтения тонут в поиске тысячи
таблиц.
На этом примере стало понятно, почему необходимо знать об устройстве базы данных внутри, для её использования. Ведь даже хорошо
написанную базу можно сломать, просто неправильно её настроив.


##### Результаты
Посмотреть результаты async-profiler: src/main/java/ru/vk/itmo/test/asvistukhin/reports/async_profiler/lab2

Скрипты для генерации wrk запросов: src/main/java/ru/vk/itmo/test/asvistukhin/reports/wrk_script