# Этап 4. Репликация

## PUT
В этом этапе я изменила логику создания Http клиентов, поэтому для объективности сравнения нагрузим сперва с кодом идентичным 3 этапу:
Было:

| RPS   | Avg Latency |
|-------|-------------|
| 20000 | 1.69ms      |
| 28000 | 5.92ms      |
| 32000 | 6.42ms      |
Стало:

| RPS   | Avg Latency |
|-------|-------------|
| 10000 | 1.84ms      |
| 15000 | 2.12ms      |
| 20000 | 16.08ms     |

Очевидно, что средняя latency ухудшилась, так как теперь запрос рассылаеется по нескольким нодам и необходимо дождаться ответа от них.

Теперь создадим HttpClient с FixedThreadPool(availableProcessors) в качестве executor.

| RPS   | Avg Latency |
|-------|-------------|
| 15000 | 1.84ms      | 
| 20000 | 2.26ms      | 
| 25000 | 259.14ms    |

Итого, средняя latency заметно приблизилась к результатам 3 этапа

Посмотрим на результаты профилирования для 20000 rps
```dtd
Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    1.57ms
 75.000%    2.30ms
 90.000%    3.12ms
 99.000%    6.86ms
 99.900%   10.29ms
 99.990%   13.61ms
 99.999%   15.94ms
100.000%   17.81ms
```

[CPU profile](data/stage4/profile-put-20000.html)
[Alloc profile](data/stage4/profile-put-20000-alloc.html)
[Lock profile](data/stage4/profile-put-20000-lock.html)

Около 30% сэмплов занимает park при взятии задачи из очереди запросов
По сравнению с предыдущим этапом количество сэмплов на ThreadPoolExecutor getTask сократилось с 41% до 25%, а на редирект
(redirectRequest) наоборот с 12% выросло до 20%
Наибольшую часть занимают аллокации при редиректе запроса 59% (против 50% на предыдущем этапе)
Аналогично с 3 этапом основное время ожидания блокировок приходится на HttpClient (SequentialScheduler.run(), HttpClientImpl.send(), SelectorManager.run())
Из них 34% во время редиректа запроса.

## GET
Аналогично сравним GET
Было:

| RPS   | Avg Latency |
|-------|-------------|
| 25000 |  1.65ms     |
| 30000 | 2.46ms      |
| 35000 | 19.83ms     |

Стало:

| RPS   | Avg Latency |
|-------|-------------|
| 10000 | 1.73ms      |
| 15000 | 2.12ms      |
| 20000 | 10.30ms     |
| 25000 | 2.88s       |

Добавим executor в HttpClient:

| RPS   | Avg Latency |
|-------|-------------|
| 25000 | 1.83ms      |
| 28000 | 1.99ms      |
| 30000 | 35.38ms     |

Ситуация аналогичная с PUT, latency ухудшается, так как необходимо собрать кворум запросов.

[CPU profile](data/stage4/profile-get-25000.html)
[Alloc profile](data/stage4/profile-get-25000-alloc.html)
[Lock profile](data/stage4/profile-get-25000-lock.html)

Аналогично с PUT чуть больше 30% сэмплов уходит на park, на редирект уходит 20%, что касается локов - 36% на редирект, а было 32%.