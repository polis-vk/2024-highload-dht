# Этап 5. Асинхронное взаимодействие

## PUT
Было:

| RPS   | Avg Latency |
|-------|-------------|
| 15000 | 1.84ms      | 
| 20000 | 2.26ms      | 
| 25000 | 259.14ms    |

Стало:

| RPS   | Avg Latency |
|-------|-------------|
| 10000 | 1.89ms      | 
| 12000 | 1.96ms      | 
| 15000 | 33.53ms     |

По сравнению с предыдущим этапом пропускная способность уменьшилась примерно на одну треть.

Посмотрим на результаты профилирования для 10000 rps
```dtd
        Thread Stats   Avg      Stdev     Max   +/- Stdev
        Latency     1.89ms    1.01ms  11.94ms   80.43%
        Req/Sec    10.55k     1.36k   18.67k    78.58%
        Latency Distribution (HdrHistogram - Recorded Latency)
        50.000%    1.66ms
        75.000%    2.28ms
        90.000%    3.07ms
        99.000%    6.09ms
        99.900%    9.10ms
        99.990%   10.67ms
        99.999%   11.62ms
        100.000%   11.95ms
```

[CPU profile](data/stage5/profile-put-10000.html)

[Alloc profile](data/stage5/profile-put-10000-alloc.html)

[Lock profile](data/stage5/profile-put-10000-lock.html)

Распределение сэмплов особо не изменилось по сравнению с предыдущим этапом, но добавились сэмплы на работу CompletableFuture,
которые составляют чуть больше 6%. Примерно половина этих сэмплов - ожидание блокировок.
На аллокации, связанные с работой CompletableFuture уходит 34% сэмплов, это больше, чем на редирект (~19%), который занимал больше всего сэмплов в предыдущем этапе.
27% ожидания на блокировках происходит во время работы CompletableFuture. Но все же, суммарно блокировки при работе HttpClient (составлявшие бОльшую часть на предыдущем этапе)
занимают больше в процентном соотношении.

## GET
Аналогично сравним GET
Было:

| RPS   | Avg Latency |
|-------|-------------|
| 25000 | 1.83ms      |
| 28000 | 1.99ms      |
| 30000 | 35.38ms     |

Стало:

| RPS   | Avg Latency |
|-------|-------------|
| 10000 | 1.84ms      |
| 15000 | 2.14ms      |
| 17000 | 2.57ms      |
| 20000 | 3.15s       |

Посмотрим на результаты профилирования для 10000 rps
```dtd
Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     1.84ms    2.86ms  47.52ms   94.76%
    Req/Sec    10.21k     2.67k   44.22k    91.25%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    1.26ms
 75.000%    1.81ms
 90.000%    2.49ms
 99.000%   15.66ms
 99.900%   33.79ms
 99.990%   43.23ms
 99.999%   45.89ms
100.000%   47.55ms
```

Ситуация аналогичная с PUT, latency ухудшается, а пропускная способность падает почти в 2 раза.

[CPU profile](data/stage5/profile-get-10000.html)

[Alloc profile](data/stage5/profile-get-10000-alloc.html)

[Lock profile](data/stage5/profile-get-10000-lock.html)

По сравнению с PUT на работу CompletableFuture уходит больше сэмплов (в процентном соотношении) - 33%.
С аллокациями ситуация аналогичная с PUT: ~34%.
Аналогично и с блокировками, время на ожидания при работе HttpClient больше, чем на CompletableFuture (~13% против ~40%).