# Отчет по второму этапу

## В качестве очереди были рассмотрены

- ArrayBlockingQueue<> - с указанием длины очереди
- LinkedBlockingQueue<> - c указанием длины очереди
  Другие очереди не подходят нам, бытрее оказалась ArrayBlockingQueue использует внутренний массив для хранения элементов, что обеспечивает более эффективный доступ к элементам в памяти.

## Выбор количество тредов обработки запросов к dao
После добавление многопоточной обработки запросов в дао,
используя wrk с параметрами -c 128 -t 128 для создания большого количества get запросов,
поэкспериментирем с количеством потоков для обработки 2, 4, 8, 16, 32 - колчиство ядер у меня 8 с 2 потоками на ядро.

- 2 - 50000 при средней задержке 153.34ms
- 4 - 83000 при средней задержке 140.93ms
- 8 - 154000 при средней задержке 91.65ms
- 16 - 175000 при средней задержке 162.43ms
- 32 - 135000 при средней задержке 89.73ms

Делаем вывод оптимальное значение 16 потоков.

## Сделаем замер для точек расладки при put и get

Все замеры проводились на прогретом и наполненном сервере.

### get

Значение в 175000 было было получено как оптимальное.

```
/home/georgii/Documents/wrk2/wrk -c 128 -d 10 -t 128 -L -R 175000 -s ./src/main/java/ru/vk/itmo/test/georgiidalbeev/lab2/scripts/get.lua http://localhost:8080
Running 10s test @ http://localhost:8080

  128 threads and 128 connections
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency    46.72ms   38.76ms 245.76ms   67.61%
    Req/Sec       -nan      -nan   0.00      0.00%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%   37.98ms
 75.000%   70.21ms
 90.000%  101.63ms
 99.000%  162.43ms
 99.900%  201.09ms
 99.990%  229.25ms
 99.999%  243.07ms
100.000%  245.89ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.046     0.000000            1         1.00
       3.745     0.100000       173832         1.11
      11.079     0.200000       347700         1.25
      19.279     0.300000       521574         1.43
      27.903     0.400000       695236         1.67
      37.983     0.500000       869292         2.00
      43.519     0.550000       956085         2.22
      49.343     0.600000      1043008         2.50
      55.775     0.650000      1129884         2.86
      62.687     0.700000      1216541         3.33
      70.207     0.750000      1304017         4.00
      74.239     0.775000      1347476         4.44
      78.591     0.800000      1390709         5.00
      83.263     0.825000      1433819         5.71
      88.639     0.850000      1477336         6.67
      94.719     0.875000      1520909         8.00
      98.111     0.887500      1542650         8.89
     101.631     0.900000      1564234        10.00
     105.407     0.912500      1585875        11.43
     109.695     0.925000      1607763        13.33
     114.623     0.937500      1629342        16.00
     117.503     0.943750      1640349        17.78
     120.511     0.950000      1651057        20.00
     124.159     0.956250      1661891        22.86
     128.831     0.962500      1672797        26.67
     134.015     0.968750      1683732        32.00
     136.959     0.971875      1689057        35.56
     140.415     0.975000      1694598        40.00
     144.127     0.978125      1699991        45.71
     147.967     0.981250      1705379        53.33
     152.319     0.984375      1710835        64.00
     154.751     0.985938      1713480        71.11
     157.567     0.987500      1716250        80.00
     160.639     0.989062      1718975        91.43
     163.711     0.990625      1721607       106.67
     167.167     0.992188      1724350       128.00
     169.087     0.992969      1725656       142.22
     171.391     0.993750      1727061       160.00
     174.079     0.994531      1728364       182.86
     178.047     0.995313      1729746       213.33
     182.015     0.996094      1731094       256.00
     184.191     0.996484      1731769       284.44
     186.751     0.996875      1732465       320.00
     188.799     0.997266      1733149       365.71
     190.975     0.997656      1733813       426.67
     193.407     0.998047      1734483       512.00
     194.943     0.998242      1734821       568.89
     196.095     0.998437      1735160       640.00
     197.631     0.998633      1735513       731.43
     199.423     0.998828      1735831       853.33
     201.215     0.999023      1736175      1024.00
     202.239     0.999121      1736340      1137.78
     203.775     0.999219      1736519      1280.00
     205.311     0.999316      1736688      1462.86
     207.359     0.999414      1736854      1706.67
     209.919     0.999512      1737021      2048.00
     211.199     0.999561      1737108      2275.56
     212.479     0.999609      1737195      2560.00
     213.759     0.999658      1737275      2925.71
     215.167     0.999707      1737359      3413.33
     218.751     0.999756      1737448      4096.00
     219.775     0.999780      1737492      4551.11
     220.543     0.999805      1737528      5120.00
     222.335     0.999829      1737571      5851.43
     224.511     0.999854      1737613      6826.67
     226.815     0.999878      1737655      8192.00
     228.095     0.999890      1737677      9102.22
     229.631     0.999902      1737699     10240.00
     231.295     0.999915      1737719     11702.86
     233.471     0.999927      1737741     13653.33
     237.055     0.999939      1737761     16384.00
     238.335     0.999945      1737773     18204.44
     239.359     0.999951      1737786     20480.00
     239.615     0.999957      1737793     23405.71
     240.383     0.999963      1737807     27306.67
     240.767     0.999969      1737814     32768.00
     241.151     0.999973      1737820     36408.89
     241.663     0.999976      1737825     40960.00
     241.919     0.999979      1737830     46811.43
     242.431     0.999982      1737836     54613.33
     242.815     0.999985      1737841     65536.00
     242.943     0.999986      1737847     72817.78
     242.943     0.999988      1737847     81920.00
     243.071     0.999989      1737850     93622.86
     243.327     0.999991      1737852    109226.67
     243.583     0.999992      1737854    131072.00
     243.967     0.999993      1737856    145635.56
     244.095     0.999994      1737857    163840.00
     244.223     0.999995      1737858    187245.71
     244.479     0.999995      1737860    218453.33
     244.607     0.999996      1737861    262144.00
     244.863     0.999997      1737862    291271.11
     244.863     0.999997      1737862    327680.00
     244.991     0.999997      1737863    374491.43
     245.119     0.999998      1737864    436906.67
     245.119     0.999998      1737864    524288.00
     245.375     0.999998      1737865    582542.22
     245.375     0.999998      1737865    655360.00
     245.375     0.999999      1737865    748982.86
     245.759     0.999999      1737866    873813.33
     245.759     0.999999      1737866   1048576.00
     245.759     0.999999      1737866   1165084.44
     245.759     0.999999      1737866   1310720.00
     245.759     0.999999      1737866   1497965.71
     245.887     0.999999      1737867   1747626.67
     245.887     1.000000      1737867          inf
#[Mean    =       46.724, StdDeviation   =       38.759]
#[Max     =      245.760, Total count    =      1737867]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  1737995 requests in 9.97s, 119.80MB read
  Non-2xx or 3xx responses: 313338
Requests/sec: 174294.90
Transfer/sec:     12.01MB
```

График этого распределения:
![get.png](..%2Flab2%2Fwrk_result%2Fget.png)

### put

Значение в 175000 было было получено как оптимальное.

```
/home/georgii/Documents/wrk2/wrk -c 128 -d 10 -t 128 -L -R 172000 -s ./src/main/java/ru/vk/itmo/test/georgiidalbeev/lab2/scripts/fill.lua http://localhost:8080
Running 10s test @ http://localhost:8080
  128 threads and 128 connections
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency    10.72ms   11.57ms 132.99ms   85.51%
    Req/Sec       -nan      -nan   0.00      0.00%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    6.59ms
 75.000%   15.53ms
 90.000%   27.15ms
 99.000%   49.50ms
 99.900%   71.17ms
 99.990%  117.44ms
 99.999%  131.33ms
100.000%  133.12ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.050     0.000000            1         1.00
       1.025     0.100000       171477         1.11
       1.563     0.200000       342913         1.25
       2.495     0.300000       514556         1.43
       4.215     0.400000       686027         1.67
       6.595     0.500000       857274         2.00
       7.991     0.550000       943109         2.22
       9.535     0.600000      1028992         2.50
      11.247     0.650000      1114607         2.86
      13.239     0.700000      1200050         3.33
      15.527     0.750000      1285922         4.00
      16.831     0.775000      1329047         4.44
      18.271     0.800000      1371701         5.00
      19.951     0.825000      1414634         5.71
      21.871     0.850000      1457411         6.67
      24.287     0.875000      1500232         8.00
      25.663     0.887500      1521536         8.89
      27.151     0.900000      1543024        10.00
      28.751     0.912500      1564357        11.43
      30.575     0.925000      1585902        13.33
      32.655     0.937500      1607294        16.00
      33.791     0.943750      1618104        17.78
      34.975     0.950000      1628662        20.00
      36.287     0.956250      1639366        22.86
      37.759     0.962500      1650159        26.67
      39.455     0.968750      1660818        32.00
      40.447     0.971875      1666286        35.56
      41.535     0.975000      1671615        40.00
      42.751     0.978125      1676906        45.71
      44.127     0.981250      1682219        53.33
      45.695     0.984375      1687583        64.00
      46.623     0.985938      1690337        71.11
      47.615     0.987500      1692937        80.00
      48.735     0.989062      1695601        91.43
      50.015     0.990625      1698285       106.67
      51.551     0.992188      1700973       128.00
      52.479     0.992969      1702308       142.22
      53.503     0.993750      1703640       160.00
      54.623     0.994531      1705000       182.86
      55.807     0.995313      1706332       213.33
      57.151     0.996094      1707685       256.00
      57.951     0.996484      1708341       284.44
      58.847     0.996875      1708996       320.00
      59.967     0.997266      1709672       365.71
      61.247     0.997656      1710341       426.67
      63.007     0.998047      1711013       512.00
      64.127     0.998242      1711348       568.89
      65.471     0.998437      1711673       640.00
      67.071     0.998633      1712008       731.43
      69.119     0.998828      1712345       853.33
      71.423     0.999023      1712677      1024.00
      72.767     0.999121      1712847      1137.78
      74.751     0.999219      1713016      1280.00
      78.399     0.999316      1713181      1462.86
      80.383     0.999414      1713347      1706.67
      84.735     0.999512      1713515      2048.00
      87.039     0.999561      1713598      2275.56
      88.575     0.999609      1713682      2560.00
      90.367     0.999658      1713769      2925.71
      93.055     0.999707      1713849      3413.33
     107.135     0.999756      1713933      4096.00
     110.015     0.999780      1713975      4551.11
     111.231     0.999805      1714018      5120.00
     112.895     0.999829      1714059      5851.43
     114.239     0.999854      1714100      6826.67
     115.967     0.999878      1714142      8192.00
     116.671     0.999890      1714163      9102.22
     117.567     0.999902      1714185     10240.00
     118.911     0.999915      1714205     11702.86
     119.615     0.999927      1714227     13653.33
     121.471     0.999939      1714247     16384.00
     122.367     0.999945      1714258     18204.44
     122.751     0.999951      1714269     20480.00
     123.071     0.999957      1714279     23405.71
     123.839     0.999963      1714289     27306.67
     124.991     0.999969      1714299     32768.00
     126.015     0.999973      1714305     36408.89
     126.335     0.999976      1714310     40960.00
     126.783     0.999979      1714315     46811.43
     127.103     0.999982      1714320     54613.33
     127.935     0.999985      1714325     65536.00
     129.215     0.999986      1714328     72817.78
     130.623     0.999988      1714331     81920.00
     131.199     0.999989      1714333     93622.86
     131.839     0.999991      1714337    109226.67
     131.967     0.999992      1714339    131072.00
     132.223     0.999993      1714342    145635.56
     132.223     0.999994      1714342    163840.00
     132.223     0.999995      1714342    187245.71
     132.479     0.999995      1714346    218453.33
     132.479     0.999996      1714346    262144.00
     132.479     0.999997      1714346    291271.11
     132.479     0.999997      1714346    327680.00
     132.735     0.999997      1714347    374491.43
     132.863     0.999998      1714350    436906.67
     132.863     0.999998      1714350    524288.00
     132.863     0.999998      1714350    582542.22
     132.863     0.999998      1714350    655360.00
     132.863     0.999999      1714350    748982.86
     132.863     0.999999      1714350    873813.33
     132.863     0.999999      1714350   1048576.00
     132.863     0.999999      1714350   1165084.44
     132.863     0.999999      1714350   1310720.00
     132.863     0.999999      1714350   1497965.71
     133.119     0.999999      1714351   1747626.67
     133.119     1.000000      1714351          inf
#[Mean    =       10.715, StdDeviation   =       11.574]
#[Max     =      132.992, Total count    =      1714351]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  1714479 requests in 9.86s, 109.55MB read
Requests/sec: 173802.67
Transfer/sec:     11.11MB
```

График этого распределения:

![put.png](..%2Flab2%2Fwrk_result%2Fput.png)

### Проведем исследование влини количества соединений на latency

Выполнялось на get запросах на прогретом сервере.

- -c 256 -t 256 ---> 175000 со средней задержкой 238.88ms и отклонением 184.32ms
- -c 128 -t 128 ---> 175000 со средней задержкой 46.72ms и отклонением 38.76ms
- -c 64 -t 64 ---> 175000 со средней задержкой 1.49s и отклонением 868.67ms
- -c 32 -t 32 ---> 175000 со средней задержкой 2.47s и отклонением 1.47s
- -c 16 -t 16 ---> 175000 со средней задержкой 2.90s и отклонением 1.67s

Делаем вывод что оптимальное значение 128 потоков.

## Async-profiler

Выполнялось на прогретом сервере.

## get

### cpu

- отправка ответа занимает 21% времени
- чтение запроса занимает 5%
- работа базы данных 69%

### alloc

- отправка ответа занимает 19% выделений памяти
- чтение запроса занимает 32% выделений памяти
- работа базы данных 40% выделений памяти (формирование Response - 14%, преобразование MemorySegment в массив байтов для ответа 7%, преобразование ключа из запроса в MemorySegment - 11%, выделения внутри dao - 7% во время маппинга таблиц с диска)

### lock

- ArrayBlockingQueue в моем новом ThreadPoolExecuter - 2%
- httpSession (без уточнений) - 95%
- httpSession.Read - 3%

## put

### cpu

- отправка ответа занимает 68% времени
- чтение запроса занимает 10%
- работа базы данных 12%

### alloc

- отправка ответа занимает 14% выделений памяти
- чтение запроса занимает 47% выделений памяти
- работа базы данных 30% выделений памяти (формирование Response - 15%, преобразование MemorySegment в массив байтов для ответа 8%, преобразование ключа из запроса в MemorySegment - 7%

### lock

- ArrayBlockingQueue в моем новом ThreadPoolExecuter - 20%
- httpSession (без уточнений) - 65%
- httpSession.Read - 26%

## Замеры по каждому из потоков

Потоки работают примерно одинаково по нагрзуке на процесор, выделению памяти и блокировкам.

Дополнительной информации, рассмотрев потоки в работе по отдельности, выявить не удалось.