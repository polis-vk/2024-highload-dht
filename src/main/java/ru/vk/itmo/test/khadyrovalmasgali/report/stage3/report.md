# Отчёт Stage 3

Тестирование на 4 инстансах показало [равномерное
распределение](./pic/img.png) таблиц на диске между инстансами - значит,
стратегия хэширования не подвела. Последующее тестирование проводилось
на 2 инстансах. Lua скрипты с прошлого этапа не изменились.

[get cpu profile](./asprof/cluster_get_cpu.html)

[put cpu profile](./asprof/cluster_put_cpu.html)

[get alloc profile](./asprof/cluster_get_alloc.html)

[put alloc profile](./asprof/cluster_put_alloc.html)

[get lock profile](./asprof/cluster_get_lock.html)

[put lock profile](./asprof/cluster_put_lock.html)

### GET

Предварительно на диск выгружено 200MB данных.

25k RPS - на трех девятках уже плохо.

| Percentile | time     |
|------------|----------|
| 50.000%    | 5.18ms   |
| 75.000%    | 26.70ms  |
| 90.000%    | 119.42ms |
| 99.000%    | 247.17ms |
| 99.900%    | 298.24ms |
| 99.990%    | 339.71ms |
| 99.999%    | 358.91ms |
| 100.000%   | 361.21ms |

22k RPS

| Percentile | time    |
|------------|---------|
| 50.000%    | 1.65ms  |
| 75.000%    | 2.35ms  |
| 90.000%    | 3.69ms  |
| 99.000%    | 35.29ms |
| 99.900%    | 65.92ms |
| 99.990%    | 79.10ms |
| 99.999%    | 85.69ms |
| 100.000%   | 87.49ms |

Прошлый этап.

| Percentile | time    |
|------------|---------|
| 50.000%    | 1.45ms  |
| 75.000%    | 2.11ms  |
| 90.000%    | 4.04ms  |
| 99.000%    | 12.97ms |
| 99.900%    | 23.85ms |
| 99.990%    | 33.69ms |
| 99.999%    | 41.69ms |
| 100.000%   | 51.87ms |

### PUT

50k RPS

| Percentile | time     |
|------------|----------|
| 50.000%    | 1.38ms   |
| 75.000%    | 1.95ms   |
| 90.000%    | 2.62ms   |
| 99.000%    | 12.94ms  |
| 99.900%    | 82.05ms  |
| 99.990%    | 104.00ms |
| 99.999%    | 111.29ms |
| 100.000%   | 112.89ms |

Прошлый этап

| Percentile | time    |
|------------|---------|
| 50.000%    | 1.28ms  |
| 75.000%    | 1.81ms  |
| 90.000%    | 2.43ms  |
| 99.000%    | 7.76ms  |
| 99.900%    | 16.04ms |
| 99.990%    | 32.49ms |
| 99.999%    | 43.52ms |
| 100.000%   | 47.68ms |

Заметно значительное падение производительности. С чем это связано?
Ну, во первых, несколько кластеров на одной машине - это только дополнительные
накладные расходы, все ресурсы машины были задействованы в полном объеме
еще на прошлом этапе. Во вторых, теперь мы упираемся в блокирующий HttpClient.
В put lock profile HttpClient и HttpSession занимают 62% сэмплов,
в get lock profile - 68%. Решение - уходить в асинхронщину.

А ещё - 70% всех аллокаций в обоих методах приходится на handleRedirect.
Общаться через HttpClient дорого.
