# stage 1

## WRK2
### Выбор параметров
Изначально RPS был меньше 10000. Была добавлена обработка исключения при вставке:
`IllegalStateException`. После этого при RPS = 80 000 перцентиль 50% дала время
обработки больше 1 секунды.
Таким образом, было выбрано значение RPS = 65 000 для запросов вставки.

```shell
wrk -d 30 -t 1 -c 1 -R 65000 -L -s ./put_req.lua http://127.0.0.1:8080 
```

При RPS = 100 для запросов получения значений на 10-ой перцентили произошело резкое ухудшение.
Таким образом, было выбрано значение RPS = 90 для запросов получения значений.
```shell
wrk -d 30 -t 1 -c 1 -R 90 -L -s ./get_req.lua http://127.0.0.1:8080 
```
Вставка:
```shell
wrk -d 55 -t 1 -c 1 -R 7000 -L -s ./lua/put_req.lua http://127.0.0.1:8080
```


Проверка наличия данных:
```shell
curl --request PUT --data-binary ss -i http://127.0.0.1:8080/v0/entity?id=1
curl --request GET -i http://127.0.0.1:8080/v0/entity?id=1
```

### Результат тестирования WRK PUT

```text
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.010     0.000000            8         1.00
       0.351     0.100000       130134         1.11
       0.658     0.200000       260264         1.25
       0.950     0.300000       390173         1.43
       1.500     0.400000       520323         1.67
       2.853     0.500000       650329         2.00
       3.765     0.550000       715334         2.22
       4.839     0.600000       780343         2.50
       6.139     0.650000       845488         2.86
       7.591     0.700000       910490         3.33
       9.191     0.750000       975434         4.00
      10.151     0.775000      1007933         4.44
      11.183     0.800000      1040510         5.00
      12.135     0.825000      1073041         5.71
      13.327     0.850000      1105488         6.67
      14.807     0.875000      1138009         8.00
      15.567     0.887500      1154365         8.89
      16.447     0.900000      1170567        10.00
      17.343     0.912500      1186880        11.43
      18.447     0.925000      1203153        13.33
      19.999     0.937500      1219385        16.00
      20.767     0.943750      1227436        17.78
      21.839     0.950000      1235505        20.00
      23.423     0.956250      1243718        22.86
      24.735     0.962500      1251754        26.67
      26.271     0.968750      1259947        32.00
      27.167     0.971875      1263970        35.56
      28.303     0.975000      1268023        40.00
      29.391     0.978125      1272133        45.71
      30.383     0.981250      1276167        53.33
      31.471     0.984375      1280249        64.00
      32.063     0.985938      1282284        71.11
      32.687     0.987500      1284299        80.00
      33.855     0.989062      1286320        91.43
      35.263     0.990625      1288359       106.67
      36.191     0.992188      1290413       128.00
      36.575     0.992969      1291429       142.22
      37.119     0.993750      1292423       160.00
      38.399     0.994531      1293425       182.86
      39.711     0.995313      1294430       213.33
      40.831     0.996094      1295458       256.00
      41.343     0.996484      1295958       284.44
      42.463     0.996875      1296465       320.00
      43.711     0.997266      1296983       365.71
      45.023     0.997656      1297481       426.67
      45.727     0.998047      1297988       512.00
      46.399     0.998242      1298237       568.89
      46.911     0.998437      1298506       640.00
      47.231     0.998633      1298749       731.43
      47.359     0.998828      1298999       853.33
      47.519     0.999023      1299293      1024.00
      47.583     0.999121      1299424      1137.78
      47.647     0.999219      1299535      1280.00
      47.711     0.999316      1299639      1462.86
      47.807     0.999414      1299784      1706.67
      47.903     0.999512      1299926      2048.00
      47.935     0.999561      1299954      2275.56
      48.095     0.999609      1300019      2560.00
      48.255     0.999658      1300083      2925.71
      48.383     0.999707      1300164      3413.33
      48.447     0.999756      1300211      4096.00
      48.479     0.999780      1300241      4551.11
      48.575     0.999805      1300273      5120.00
      48.671     0.999829      1300309      5851.43
      48.735     0.999854      1300339      6826.67
      48.831     0.999878      1300376      8192.00
      48.863     0.999890      1300386      9102.22
      48.895     0.999902      1300396     10240.00
      48.959     0.999915      1300423     11702.86
      48.991     0.999927      1300439     13653.33
      49.023     0.999939      1300458     16384.00
      49.023     0.999945      1300458     18204.44
      49.055     0.999951      1300469     20480.00
      49.055     0.999957      1300469     23405.71
      49.087     0.999963      1300485     27306.67
      49.087     0.999969      1300485     32768.00
      49.119     0.999973      1300496     36408.89
      49.119     0.999976      1300496     40960.00
      49.119     0.999979      1300496     46811.43
      49.151     0.999982      1300522     54613.33
      49.151     1.000000      1300522          inf
#[Mean    =        6.173, StdDeviation   =        7.684]
#[Max     =       49.120, Total count    =      1300522]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  1949859 requests in 30.00s, 132.82MB read
  Non-2xx or 3xx responses: 200799
Requests/sec:  64997.06
Transfer/sec:      4.43MB
```
<br>

### Результат тестирования WRK GET
```text
       Value   Percentile   TotalCount 1/(1-Percentile)

       9.511     0.000000            1         1.00
      10.303     0.100000          182         1.11
      10.503     0.200000          362         1.25
      10.639     0.300000          541         1.43
      10.791     0.400000          725         1.67
      10.935     0.500000          907         2.00
      10.999     0.550000          997         2.22
      11.071     0.600000         1092         2.50
      11.143     0.650000         1179         2.86
      11.215     0.700000         1261         3.33
      11.311     0.750000         1357         4.00
      11.359     0.775000         1400         4.44
      11.399     0.800000         1444         5.00
      11.455     0.825000         1493         5.71
      11.495     0.850000         1530         6.67
      11.583     0.875000         1575         8.00
      11.639     0.887500         1599         8.89
      11.687     0.900000         1621        10.00
      11.743     0.912500         1645        11.43
      11.807     0.925000         1665        13.33
      11.911     0.937500         1687        16.00
      12.015     0.943750         1698        17.78
      12.215     0.950000         1710        20.00
      12.495     0.956250         1721        22.86
      12.975     0.962500         1732        26.67
      13.807     0.968750         1743        32.00
      15.007     0.971875         1749        35.56
      17.263     0.975000         1755        40.00
      20.223     0.978125         1760        45.71
      22.815     0.981250         1766        53.33
      24.735     0.984375         1771        64.00
      25.967     0.985938         1774        71.11
      27.087     0.987500         1777        80.00
      28.463     0.989062         1780        91.43
      30.191     0.990625         1783       106.67
      30.879     0.992188         1785       128.00
      31.471     0.992969         1787       142.22
      31.951     0.993750         1788       160.00
      33.087     0.994531         1790       182.86
      33.247     0.995313         1791       213.33
      33.983     0.996094         1792       256.00
      34.271     0.996484         1793       284.44
      34.943     0.996875         1795       320.00
      34.943     0.997266         1795       365.71
      34.943     0.997656         1795       426.67
      35.359     0.998047         1796       512.00
      35.359     0.998242         1796       568.89
      35.615     0.998437         1797       640.00
      35.615     0.998633         1797       731.43
      35.615     0.998828         1797       853.33
      36.031     0.999023         1798      1024.00
      36.031     0.999121         1798      1137.78
      36.031     0.999219         1798      1280.00
      36.031     0.999316         1798      1462.86
      36.031     0.999414         1798      1706.67
      36.063     0.999512         1799      2048.00
      36.063     1.000000         1799          inf
#[Mean    =       11.373, StdDeviation   =        2.770]
#[Max     =       36.032, Total count    =         1799]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  2700 requests in 30.00s, 211.44KB read
  Non-2xx or 3xx responses: 239
Requests/sec:     90.00
Transfer/sec:      7.05KB
```

##  async-profiler

### Подготовка

Настройка окружения:
```shell
cd /opt/async-profiler-3.0-linux-x64
export PATH=$PATH:/opt/async-profiler-3.0-linux-x64
export JAVA_HOME=/home/user/.jdks/openjdk-21.0.1
export PATH=$JAVA_HOME/bin:$PATH

source ~/.bashrc

sudo sysctl kernel.perf_event_paranoid=1
# sudo sysctl kernel.kptr_restrict=0

jps -m
```
<br>

Запуск профилирования:
```shell
./bin/asprof -e cpu,alloc -d 25 -f "/media/user/DATA/projects/gitproj/DWS-ITMO-2023/sem 2/profile.jfr" MainServ
```
<br>

Экспорт данных:
```shell
PROF_NUMB=1
METHOD_NAME=get
java -cp lib/converter.jar jfr2flame --alloc "/media/user/DATA/projects/gitproj/DWS-ITMO-2023/sem 2/profile.jfr" > "/media/user/DATA/projects/gitproj/DWS-ITMO-2023/sem 2/profile${PROF_NUMB}-${METHOD_NAME}-alloc.html"
java -cp lib/converter.jar jfr2flame "/media/user/DATA/projects/gitproj/DWS-ITMO-2023/sem 2/profile.jfr" > "/media/user/DATA/projects/gitproj/DWS-ITMO-2023/sem 2/profile${PROF_NUMB}-${METHOD_NAME}-cpu.html"
```

### Результаты async-profiler

#### Вставка данных
- За счет ответа 500 при попытке записи данных в процессе операции flush получилось сильно увеличить допустимый RPS.
- Около 17% процессорного времени было потрачено на кодогенерацию: если запустить нагрузку с профилированием несколько раз подряд, то кодогенерации мы не увидим.
- Около 9% процессорного времени было потрачено на вставку данных.
- Около 32% процессорного времени было потрачено на flush в процессе вставики.
- Ожидаемо около 74% аллокаций происходило в процессе операции flush.
- Около 26% аллокаций заняли действия, связанные с Http сервером. Из них 4% было потрачено на перевод UTF-8 строки в ASCII и потом в массив байт. 2% на конвертацию заголовков и тел ответов. Около 15% заняли аллокации для метода `getDaoMethod`.

#### Получение данных
- Получение данных имеет в разы меньшую пропускную способность относительно вставки из-за особенности хранилища.
- Около 95% процессорного времени было потрачено получение значения из хранилища (бинарный поиск).
- Конвертация `MemorySegment` в `byte[]` заняла около 25% аллокаций.
- Оставшиеся 75% были заняты аллокациями для парсинга запроса и конвертации ответа.