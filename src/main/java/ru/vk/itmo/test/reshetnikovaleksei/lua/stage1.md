# Stage 1

### PUT TEST

При `RPS`, равному `15_000` получаю следующие результаты:
```
 Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.036     0.000000            3         1.00
       0.567     0.100000        29638         1.11
       1.022     0.200000        59189         1.25
       1.991     0.300000        88751         1.43
       3.313     0.400000       118369         1.67
       4.651     0.500000       147941         2.00
       5.399     0.550000       162687         2.22
       6.291     0.600000       177521         2.50
      11.183     0.650000       192266         2.86
      39.167     0.700000       207071         3.33
      55.199     0.750000       221852         4.00
      70.207     0.775000       229263         4.44
      84.863     0.800000       236634         5.00
     107.327     0.825000       244054         5.71
     120.127     0.850000       251455         6.67
     132.991     0.875000       258849         8.00
     149.503     0.887500       262520         8.89
     161.535     0.900000       266231        10.00
     169.983     0.912500       269994        11.43
     174.463     0.925000       273652        13.33
     180.095     0.937500       277319        16.00
     183.167     0.943750       279308        17.78
     188.159     0.950000       281040        20.00
     190.847     0.956250       282889        22.86
     193.791     0.962500       284823        26.67
     195.967     0.968750       286590        32.00
     197.503     0.971875       287486        35.56
     199.807     0.975000       288458        40.00
     216.959     0.978125       289341        45.71
     225.407     0.981250       290256        53.33
     228.607     0.984375       291189        64.00
     230.655     0.985938       291638        71.11
     233.599     0.987500       292104        80.00
     236.543     0.989062       292591        91.43
     236.927     0.990625       293044       106.67
     242.047     0.992188       293539       128.00
     243.839     0.992969       293713       142.22
     249.343     0.993750       293962       160.00
     249.983     0.994531       294178       182.86
     257.023     0.995313       294407       213.33
     258.175     0.996094       294693       256.00
     258.303     0.996484       294818       284.44
     258.431     0.996875       294936       320.00
     259.071     0.997266       294984       365.71
     265.215     0.997656       295098       426.67
     265.983     0.998047       295222       512.00
     266.751     0.998242       295274       568.89
     268.799     0.998437       295330       640.00
     270.591     0.998633       295405       731.43
     270.847     0.998828       295465       853.33
     271.103     0.999023       295503      1024.00
     273.151     0.999121       295534      1137.78
     274.943     0.999219       295562      1280.00
     276.735     0.999316       295591      1462.86
     277.503     0.999414       295642      1706.67
     277.759     0.999512       295699      2048.00
     277.759     0.999561       295699      2275.56
     277.759     0.999609       295699      2560.00
     277.759     0.999658       295699      2925.71
     278.015     0.999707       295786      3413.33
     278.015     0.999756       295786      4096.00
     278.015     0.999780       295786      4551.11
     278.015     0.999805       295786      5120.00
     278.015     0.999829       295786      5851.43
     278.015     0.999854       295786      6826.67
     278.015     0.999878       295786      8192.00
     278.015     0.999890       295786      9102.22
     278.015     0.999902       295786     10240.00
     278.015     0.999915       295786     11702.86
     278.015     0.999927       295786     13653.33
     278.015     0.999939       295786     16384.00
     278.015     0.999945       295786     18204.44
     278.015     0.999951       295786     20480.00
     278.015     0.999957       295786     23405.71
     278.015     0.999963       295786     27306.67
     278.015     0.999969       295786     32768.00
     278.015     0.999973       295786     36408.89
     278.015     0.999976       295786     40960.00
     278.015     0.999979       295786     46811.43
     278.015     0.999982       295786     54613.33
     278.271     0.999985       295791     65536.00
     278.271     1.000000       295791          inf
```

Смотреть больший `RPS` смысла не имеет. При `RPS`, равный `10_000` получаю резкое 
возрастание по 90%-му перцентилю вплоть до 84мс, что, по моему мнению, не очень классно. 
Было решено выбрать `RPS`, равный `7_500`

```shell
./wrk -d 30 -t 1 -c 1 -R 7500 -L -s src/main/java/ru/vk/itmo/test/reshetnikovaleksei/lua/put.lua  http://localhost:8080
```

#### Результат PUT
```
      Value   Percentile   TotalCount 1/(1-Percentile)

       0.037     0.000000            1         1.00
       0.268     0.100000        15014         1.11
       0.462     0.200000        30028         1.25
       0.647     0.300000        45012         1.43
       0.816     0.400000        60018         1.67
       0.965     0.500000        74988         2.00
       1.033     0.550000        82609         2.22
       1.094     0.600000        90066         2.50
       1.156     0.650000        97527         2.86
       1.233     0.700000       104990         3.33
       1.365     0.750000       112518         4.00
       1.441     0.775000       116237         4.44
       1.520     0.800000       120017         5.00
       1.597     0.825000       123746         5.71
       1.675     0.850000       127496         6.67
       1.754     0.875000       131247         8.00
       1.797     0.887500       133099         8.89
       1.841     0.900000       135018        10.00
       1.886     0.912500       136852        11.43
       1.935     0.925000       138722        13.33
       1.990     0.937500       140611        16.00
       2.018     0.943750       141540        17.78
       2.049     0.950000       142514        20.00
       2.081     0.956250       143421        22.86
       2.123     0.962500       144378        26.67
       2.169     0.968750       145299        32.00
       2.203     0.971875       145772        35.56
       2.253     0.975000       146216        40.00
       2.455     0.978125       146684        45.71
       2.933     0.981250       147152        53.33
       3.623     0.984375       147621        64.00
       4.491     0.985938       147854        71.11
       5.959     0.987500       148088        80.00
       8.463     0.989062       148323        91.43
      10.919     0.990625       148557       106.67
      13.591     0.992188       148791       128.00
      14.575     0.992969       148909       142.22
      15.959     0.993750       149025       160.00
      17.839     0.994531       149142       182.86
      19.711     0.995313       149260       213.33
      21.247     0.996094       149377       256.00
      21.743     0.996484       149435       284.44
      22.063     0.996875       149495       320.00
      22.415     0.997266       149553       365.71
      23.007     0.997656       149611       426.67
      23.135     0.998047       149672       512.00
      23.679     0.998242       149699       568.89
      24.303     0.998437       149728       640.00
      24.703     0.998633       149762       731.43
      25.135     0.998828       149790       853.33
      25.199     0.999023       149820      1024.00
      25.231     0.999121       149838      1137.78
      25.263     0.999219       149846      1280.00
      25.311     0.999316       149860      1462.86
      25.375     0.999414       149876      1706.67
      25.503     0.999512       149891      2048.00
      25.583     0.999561       149898      2275.56
      25.743     0.999609       149906      2560.00
      25.759     0.999658       149911      2925.71
      25.791     0.999707       149919      3413.33
      25.823     0.999756       149929      4096.00
      25.839     0.999780       149933      4551.11
      25.839     0.999805       149933      5120.00
      25.887     0.999829       149937      5851.43
      25.983     0.999854       149942      6826.67
      26.015     0.999878       149944      8192.00
      26.031     0.999890       149946      9102.22
      26.047     0.999902       149948     10240.00
      26.063     0.999915       149951     11702.86
      26.079     0.999927       149954     13653.33
      26.079     0.999939       149954     16384.00
      26.079     0.999945       149954     18204.44
      26.095     0.999951       149956     20480.00
      26.095     0.999957       149956     23405.71
      26.111     0.999963       149958     27306.67
      26.111     0.999969       149958     32768.00
      26.111     0.999973       149958     36408.89
      26.127     0.999976       149960     40960.00
      26.127     0.999979       149960     46811.43
      26.127     0.999982       149960     54613.33
      26.127     0.999985       149960     65536.00
      26.127     0.999986       149960     72817.78
      26.143     0.999988       149962     81920.00
      26.143     1.000000       149962          inf
#[Mean    =        1.190, StdDeviation   =        1.934]
#[Max     =       26.128, Total count    =       149962]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  224991 requests in 30.00s, 14.40MB read
  Non-2xx or 3xx responses: 575
Requests/sec:   7499.62
Transfer/sec:    491.50KB
```

#### Запуск профилирования для PUT
```shell
./bin/asprof -e alloc -d 30 -f ./put_alloc.html ServerRunnerApp
./bin/asprof -e cpu -d 30 -f ./put_cpu.html ServerRunnerApp
```

#### Выводы по тестированию PUT

- 57% аллокаций ушло на запись в диск (`SSTableWriter.write`)
- 9% аллокаций ушло на `flush`
- оставшиеся аллокации ушли на нужды сервера
- 3% cpu потрачено на вставку данных
- 26% cpu потрачено на `flush`

### GET TEST

Методом проб и ошибок, аналогичный при `PUT TEST`, был выбран `RPS`, равный `300`

```shell
./wrk -d 30 -t 1 -c 1 -R 300 -L -s src/main/java/ru/vk/itmo/test/reshetnikovaleksei/lua/get.lua  http://localhost:8080 
```

#### Результат GET
```
Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       1.318     0.000000            1         1.00
       1.924     0.100000          602         1.11
       2.079     0.200000         1204         1.25
       2.201     0.300000         1805         1.43
       2.323     0.400000         2405         1.67
       2.439     0.500000         3001         2.00
       2.503     0.550000         3304         2.22
       2.563     0.600000         3605         2.50
       2.615     0.650000         3906         2.86
       2.681     0.700000         4206         3.33
       2.745     0.750000         4503         4.00
       2.773     0.775000         4656         4.44
       2.803     0.800000         4806         5.00
       2.841     0.825000         4956         5.71
       2.881     0.850000         5100         6.67
       2.925     0.875000         5256         8.00
       2.949     0.887500         5330         8.89
       2.977     0.900000         5400        10.00
       3.005     0.912500         5475        11.43
       3.041     0.925000         5552        13.33
       3.073     0.937500         5625        16.00
       3.099     0.943750         5662        17.78
       3.129     0.950000         5703        20.00
       3.171     0.956250         5737        22.86
       3.227     0.962500         5775        26.67
       3.311     0.968750         5812        32.00
       3.353     0.971875         5832        35.56
       3.421     0.975000         5850        40.00
       3.555     0.978125         5868        45.71
       3.851     0.981250         5887        53.33
       4.439     0.984375         5906        64.00
       5.039     0.985938         5915        71.11
       5.907     0.987500         5925        80.00
       7.255     0.989062         5934        91.43
       7.883     0.990625         5943       106.67
       9.127     0.992188         5953       128.00
       9.335     0.992969         5957       142.22
      10.223     0.993750         5962       160.00
      10.879     0.994531         5967       182.86
      11.687     0.995313         5971       213.33
      12.207     0.996094         5976       256.00
      12.831     0.996484         5978       284.44
      13.847     0.996875         5981       320.00
      15.039     0.997266         5983       365.71
      15.671     0.997656         5985       426.67
      16.911     0.998047         5988       512.00
      17.039     0.998242         5989       568.89
      17.183     0.998437         5990       640.00
      17.487     0.998633         5991       731.43
      17.807     0.998828         5992       853.33
      19.471     0.999023         5995      1024.00
      19.471     0.999121         5995      1137.78
      19.471     0.999219         5995      1280.00
      19.471     0.999316         5995      1462.86
      20.911     0.999414         5996      1706.67
      22.303     0.999512         5997      2048.00
      22.303     0.999561         5997      2275.56
      22.303     0.999609         5997      2560.00
      22.303     0.999658         5997      2925.71
      23.695     0.999707         5998      3413.33
      23.695     0.999756         5998      4096.00
      23.695     0.999780         5998      4551.11
      23.695     0.999805         5998      5120.00
      23.695     0.999829         5998      5851.43
      24.015     0.999854         5999      6826.67
      24.015     1.000000         5999          inf
#[Mean    =        2.560, StdDeviation   =        1.193]
#[Max     =       24.000, Total count    =         5999]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  9001 requests in 30.00s, 639.62KB read
Requests/sec:    300.01
Transfer/sec:     21.32KB
```

#### Запуск профилирования для GET
```shell
./bin/asprof -e alloc -d 30 -f ./get_alloc.html ServerRunnerApp
./bin/asprof -e cpu -d 30 -f ./get_cpu.html ServerRunnerApp
```

#### Выводы по тестированию GET

- Около 93% cpu было потрачено на `SSTable.entryBinarySearch`, внутри которого
16% ушло на сравнение мемори сегментов, 4% на чтение значения по заданному
оффсету у мемори сегмента, 29% на получение размера мемори сегмента
- 25% аллокаций заняло конвертация мемори сегментов в байты
- 75% аллокаций на нужды сервера (отслеживание ивентов, создание респонса и тд)
