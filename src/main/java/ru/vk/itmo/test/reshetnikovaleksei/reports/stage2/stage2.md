# Stage 2

Параметры:
- Размер очереди - `100`
- Тип очереди - `ArrayBlockingQueue`
- Максимальное кол-во потоков - `20`

## Сравнение с результатами stage 1

Нагрузочное тестирование обновленного сервиса с такими же параметрами, как и для stage 1 (прогон с 1 потоком и 1 соединением)

Выбранные `RPS` у `stage1`:
- `PUT`: `7_500`
- `GET`: `300`

### PUT TEST

При запуске с `RPS`, равному `20_000` наблюдается резкий возрастание по 93%-му перцентилю. 

```shell
./wrk -d 30 -t 1 -c 1 -R 20000 -L -s src/main/java/ru/vk/itmo/test/reshetnikovaleksei/lua/put.lua  http://localhost:8080 

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.037     0.000000            1         1.00
       0.246     0.100000        40056         1.11
       0.430     0.200000        80159         1.25
       0.607     0.300000       120163         1.43
       0.754     0.400000       160083         1.67
       0.852     0.500000       200426         2.00
       0.890     0.550000       220075         2.22
       0.929     0.600000       240439         2.50
       0.970     0.650000       260107         2.86
       1.018     0.700000       280118         3.33
       1.074     0.750000       300172         4.00
       1.105     0.775000       310212         4.44
       1.137     0.800000       320151         5.00
       1.170     0.825000       329931         5.71
       1.239     0.850000       339931         6.67
       1.482     0.875000       349946         8.00
       1.744     0.887500       354929         8.89
       2.437     0.900000       359929        10.00
       4.019     0.912500       364923        11.43
       6.415     0.925000       369918        13.33
      12.223     0.937500       374917        16.00
      15.935     0.943750       377417        17.78
      19.151     0.950000       379914        20.00
      24.719     0.956250       382413        22.86
      32.799     0.962500       384922        26.67
      40.479     0.968750       387413        32.00
      44.351     0.971875       388676        35.56
      47.999     0.975000       389920        40.00
      51.519     0.978125       391163        45.71
      54.207     0.981250       392414        53.33
      57.023     0.984375       393676        64.00
      58.431     0.985938       394290        71.11
      59.999     0.987500       394917        80.00
      61.631     0.989062       395540        91.43
      63.071     0.990625       396166       106.67
      64.031     0.992188       396799       128.00
      64.415     0.992969       397098       142.22
      64.799     0.993750       397416       160.00
      65.151     0.994531       397739       182.86
      65.599     0.995313       398071       213.33
      66.047     0.996094       398359       256.00
      66.303     0.996484       398539       284.44
      66.559     0.996875       398712       320.00
      66.751     0.997266       398849       365.71
      67.135     0.997656       398986       426.67
      67.711     0.998047       399136       512.00
      67.903     0.998242       399208       568.89
      68.159     0.998437       399294       640.00
      68.351     0.998633       399399       731.43
      68.415     0.998828       399444       853.33
      68.543     0.999023       399527      1024.00
      68.671     0.999121       399569      1137.78
      68.735     0.999219       399604      1280.00
      68.863     0.999316       399637      1462.86
      69.055     0.999414       399687      1706.67
      69.183     0.999512       399737      2048.00
      69.183     0.999561       399737      2275.56
      69.247     0.999609       399762      2560.00
      69.311     0.999658       399818      2925.71
      69.311     0.999707       399818      3413.33
      69.311     0.999756       399818      4096.00
      69.375     0.999780       399840      4551.11
      69.375     0.999805       399840      5120.00
      69.439     0.999829       399861      5851.43
      69.439     0.999854       399861      6826.67
      69.439     0.999878       399861      8192.00
      69.503     0.999890       399879      9102.22
      69.503     0.999902       399879     10240.00
      69.503     0.999915       399879     11702.86
      69.567     0.999927       399892     13653.33
      69.567     0.999939       399892     16384.00
      69.567     0.999945       399892     18204.44
      69.567     0.999951       399892     20480.00
      69.567     0.999957       399892     23405.71
      69.631     0.999963       399909     27306.67
      69.631     1.000000       399909          inf
```

При `RPS`, равному `17_500` получаю результат, схожий с `stage1`. Скорее всего улучшения связаны с тем, что нагрузочное
тестирование было проведено после перезагрузки ноутбука (при `stage1` ноутбук был достаточно уставшим)

```shell
./wrk -d 30 -t 1 -c 1 -R 17500 -L -s src/main/java/ru/vk/itmo/test/reshetnikovaleksei/lua/put.lua  http://localhost:8080

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.038     0.000000            1         1.00
       0.221     0.100000        35171         1.11
       0.372     0.200000        70188         1.25
       0.516     0.300000       105060         1.43
       0.653     0.400000       140102         1.67
       0.785     0.500000       175204         2.00
       0.851     0.550000       192671         2.22
       0.918     0.600000       210225         2.50
       0.987     0.650000       227547         2.86
       1.059     0.700000       244999         3.33
       1.130     0.750000       262443         4.00
       1.166     0.775000       271259         4.44
       1.216     0.800000       280058         5.00
       1.317     0.825000       288725         5.71
       1.781     0.850000       297434         6.67
       3.929     0.875000       306179         8.00
       5.335     0.887500       310568         8.89
       7.535     0.900000       314933        10.00
       9.695     0.912500       319309        11.43
      12.335     0.925000       323683        13.33
      15.439     0.937500       328054        16.00
      17.039     0.943750       330261        17.78
      18.063     0.950000       332426        20.00
      19.727     0.956250       334616        22.86
      21.007     0.962500       336822        26.67
      22.127     0.968750       339018        32.00
      22.607     0.971875       340080        35.56
      23.471     0.975000       341211        40.00
      24.207     0.978125       342279        45.71
      24.991     0.981250       343371        53.33
      25.535     0.984375       344454        64.00
      25.791     0.985938       345016        71.11
      26.127     0.987500       345614        80.00
      26.271     0.989062       346101        91.43
      26.543     0.990625       346720       106.67
      26.783     0.992188       347213       128.00
      26.911     0.992969       347466       142.22
      27.151     0.993750       347777       160.00
      27.231     0.994531       348011       182.86
      27.503     0.995313       348300       213.33
      27.647     0.996094       348582       256.00
      27.695     0.996484       348697       284.44
      27.903     0.996875       348828       320.00
      28.223     0.997266       348969       365.71
      28.399     0.997656       349099       426.67
      28.479     0.998047       349243       512.00
      28.559     0.998242       349314       568.89
      28.751     0.998437       349375       640.00
      28.991     0.998633       349440       731.43
      29.103     0.998828       349509       853.33
      29.247     0.999023       349582      1024.00
      29.279     0.999121       349624      1137.78
      29.311     0.999219       349669      1280.00
      29.327     0.999316       349687      1462.86
      29.359     0.999414       349736      1706.67
      29.375     0.999512       349752      2048.00
      29.391     0.999561       349773      2275.56
      29.407     0.999609       349786      2560.00
      29.423     0.999658       349801      2925.71
      29.455     0.999707       349823      3413.33
      29.503     0.999756       349835      4096.00
      29.519     0.999780       349852      4551.11
      29.519     0.999805       349852      5120.00
      29.535     0.999829       349886      5851.43
      29.535     0.999854       349886      6826.67
      29.535     0.999878       349886      8192.00
      29.535     0.999890       349886      9102.22
      29.535     0.999902       349886     10240.00
      29.551     0.999915       349905     11702.86
      29.551     0.999927       349905     13653.33
      29.551     0.999939       349905     16384.00
      29.551     0.999945       349905     18204.44
      29.551     0.999951       349905     20480.00
      29.551     0.999957       349905     23405.71
      29.567     0.999963       349917     27306.67
      29.567     0.999969       349917     32768.00
      29.567     0.999973       349917     36408.89
      29.567     0.999976       349917     40960.00
      29.567     0.999979       349917     46811.43
      29.567     0.999982       349917     54613.33
      29.567     0.999985       349917     65536.00
      29.567     0.999986       349917     72817.78
      29.567     0.999988       349917     81920.00
      29.567     0.999989       349917     93622.86
      29.567     0.999991       349917    109226.67
      29.567     0.999992       349917    131072.00
      29.567     0.999993       349917    145635.56
      29.567     0.999994       349917    163840.00
      29.567     0.999995       349917    187245.71
      29.567     0.999995       349917    218453.33
      29.567     0.999996       349917    262144.00
      29.567     0.999997       349917    291271.11
      29.567     0.999997       349917    327680.00
      29.583     0.999997       349918    374491.43
      29.583     1.000000       349918          inf
```

### GET TEST

При `RPS`, равному `15_000` все комфортно отрабатывает:
```shell
./wrk -d 30 -t 1 -c 1 -R 15000 -L -s src/main/java/ru/vk/itmo/test/reshetnikovaleksei/lua/get.lua  http://localhost:8080

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.040     0.000000            2         1.00
       0.171     0.100000        30238         1.11
       0.287     0.200000        60043         1.25
       0.402     0.300000        90018         1.43
       0.517     0.400000       120087         1.67
       0.631     0.500000       150092         2.00
       0.689     0.550000       165004         2.22
       0.747     0.600000       180000         2.50
       0.806     0.650000       195054         2.86
       0.865     0.700000       210174         3.33
       0.922     0.750000       225039         4.00
       0.951     0.775000       232529         4.44
       0.979     0.800000       239942         5.00
       1.008     0.825000       247530         5.71
       1.037     0.850000       255090         6.67
       1.066     0.875000       262591         8.00
       1.080     0.887500       266245         8.89
       1.095     0.900000       270140        10.00
       1.109     0.912500       273732        11.43
       1.124     0.925000       277479        13.33
       1.140     0.937500       281416        16.00
       1.147     0.943750       283211        17.78
       1.154     0.950000       284936        20.00
       1.162     0.956250       286924        22.86
       1.170     0.962500       288922        26.67
       1.177     0.968750       290691        32.00
       1.181     0.971875       291695        35.56
       1.185     0.975000       292542        40.00
       1.190     0.978125       293436        45.71
       1.196     0.981250       294334        53.33
       1.204     0.984375       295250        64.00
       1.209     0.985938       295740        71.11
       1.214     0.987500       296195        80.00
       1.220     0.989062       296664        91.43
       1.227     0.990625       297138       106.67
       1.234     0.992188       297610       128.00
       1.239     0.992969       297854       142.22
       1.244     0.993750       298064       160.00
       1.250     0.994531       298289       182.86
       1.261     0.995313       298527       213.33
       1.278     0.996094       298757       256.00
       1.294     0.996484       298878       284.44
       1.321     0.996875       298990       320.00
       1.356     0.997266       299108       365.71
       1.400     0.997656       299225       426.67
       1.448     0.998047       299340       512.00
       1.478     0.998242       299400       568.89
       1.508     0.998437       299457       640.00
       1.548     0.998633       299515       731.43
       1.586     0.998828       299575       853.33
       1.658     0.999023       299633      1024.00
       1.681     0.999121       299662      1137.78
       1.728     0.999219       299691      1280.00
       1.772     0.999316       299720      1462.86
       1.837     0.999414       299751      1706.67
       1.905     0.999512       299779      2048.00
       1.961     0.999561       299794      2275.56
       2.018     0.999609       299808      2560.00
       2.061     0.999658       299823      2925.71
       2.129     0.999707       299839      3413.33
       2.197     0.999756       299852      4096.00
       2.229     0.999780       299860      4551.11
       2.249     0.999805       299869      5120.00
       2.257     0.999829       299874      5851.43
       2.277     0.999854       299882      6826.67
       2.293     0.999878       299889      8192.00
       2.299     0.999890       299893      9102.22
       2.301     0.999902       299897     10240.00
       2.309     0.999915       299900     11702.86
       2.333     0.999927       299905     13653.33
       2.343     0.999939       299908     16384.00
       2.345     0.999945       299909     18204.44
       2.349     0.999951       299911     20480.00
       2.355     0.999957       299913     23405.71
       2.361     0.999963       299915     27306.67
       2.363     0.999969       299916     32768.00
       2.371     0.999973       299917     36408.89
       2.373     0.999976       299919     40960.00
       2.373     0.999979       299919     46811.43
       2.375     0.999982       299921     54613.33
       2.375     0.999985       299921     65536.00
       2.375     0.999986       299921     72817.78
       2.377     0.999988       299922     81920.00
       2.377     0.999989       299922     93622.86
       2.381     0.999991       299924    109226.67
       2.381     0.999992       299924    131072.00
       2.381     0.999993       299924    145635.56
       2.381     0.999994       299924    163840.00
       2.381     0.999995       299924    187245.71
       2.381     0.999995       299924    218453.33
       2.381     0.999996       299924    262144.00
       2.381     0.999997       299924    291271.11
       2.387     0.999997       299925    327680.00
       2.387     1.000000       299925          inf
```

При `RPS`, равному `17_500` начинаются некоторые сложности с обработкой запросов:
```shell
./wrk -d 30 -t 1 -c 1 -R 17500 -L -s src/main/java/ru/vk/itmo/test/reshetnikovaleksei/lua/get.lua  http://localhost:8080 

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.038     0.000000            4         1.00
       0.202     0.100000        35092         1.11
       0.336     0.200000        70134         1.25
       0.464     0.300000       105116         1.43
       0.586     0.400000       139985         1.67
       0.704     0.500000       175220         2.00
       0.764     0.550000       192701         2.22
       0.823     0.600000       210156         2.50
       0.884     0.650000       227654         2.86
       0.948     0.700000       245177         3.33
       1.011     0.750000       262555         4.00
       1.043     0.775000       271266         4.44
       1.075     0.800000       279957         5.00
       1.107     0.825000       288690         5.71
       1.140     0.850000       297694         6.67
       1.172     0.875000       306373         8.00
       1.191     0.887500       310675         8.89
       1.219     0.900000       314923        10.00
       1.263     0.912500       319321        11.43
       1.361     0.925000       323675        13.33
       1.741     0.937500       328043        16.00
       2.227     0.943750       330229        17.78
       3.539     0.950000       332414        20.00
       5.251     0.956250       334604        22.86
       7.319     0.962500       336790        26.67
       9.191     0.968750       338975        32.00
      11.399     0.971875       340068        35.56
      13.647     0.975000       341164        40.00
      15.119     0.978125       342256        45.71
      17.823     0.981250       343349        53.33
      21.055     0.984375       344451        64.00
      21.791     0.985938       344988        71.11
      22.351     0.987500       345544        80.00
      23.759     0.989062       346085        91.43
      25.311     0.990625       346630       106.67
      26.991     0.992188       347177       128.00
      27.679     0.992969       347454       142.22
      28.399     0.993750       347757       160.00
      29.231     0.994531       347998       182.86
      29.743     0.995313       348271       213.33
      30.143     0.996094       348551       256.00
      30.847     0.996484       348680       284.44
      31.519     0.996875       348821       320.00
      32.095     0.997266       348953       365.71
      32.671     0.997656       349088       426.67
      33.471     0.998047       349230       512.00
      33.759     0.998242       349297       568.89
      34.015     0.998437       349384       640.00
      34.303     0.998633       349432       731.43
      34.623     0.998828       349501       853.33
      34.975     0.999023       349569      1024.00
      35.103     0.999121       349601      1137.78
      35.263     0.999219       349642      1280.00
      35.487     0.999316       349678      1462.86
      35.679     0.999414       349716      1706.67
      35.743     0.999512       349757      2048.00
      35.743     0.999561       349757      2275.56
      35.775     0.999609       349783      2560.00
      35.807     0.999658       349795      2925.71
      35.839     0.999707       349812      3413.33
      35.871     0.999756       349830      4096.00
      35.903     0.999780       349871      4551.11
      35.903     0.999805       349871      5120.00
      35.903     0.999829       349871      5851.43
      35.903     0.999854       349871      6826.67
      35.903     0.999878       349871      8192.00
      35.903     0.999890       349871      9102.22
      35.935     0.999902       349881     10240.00
      35.935     0.999915       349881     11702.86
      35.967     0.999927       349887     13653.33
      35.967     0.999939       349887     16384.00
      35.999     0.999945       349894     18204.44
      35.999     0.999951       349894     20480.00
      35.999     0.999957       349894     23405.71
      36.031     0.999963       349902     27306.67
      36.031     0.999969       349902     32768.00
      36.031     0.999973       349902     36408.89
      36.031     0.999976       349902     40960.00
      36.031     0.999979       349902     46811.43
      36.031     0.999982       349902     54613.33
      36.063     0.999985       349908     65536.00
      36.063     1.000000       349908          inf
```

## Непосредственно `stage2`

### PUT TEST

Прогон с `64` соединениями и `8` потоками. Показатели начинают ухудшаться примерно при `RPS`, равном `70_000` (методом проб и ошибок):

```shell
./wrk -d 30 -t 8 -c 64 -R 70000 -L -s src/main/java/ru/vk/itmo/test/reshetnikovaleksei/lua/put.lua  http://localhost:8080

Running 30s test @ http://localhost:8080
  8 threads and 64 connections
  Thread calibration: mean lat.: 1.364ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.364ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.357ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.372ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.360ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.369ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.365ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.367ms, rate sampling interval: 10ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency    81.55ms  114.26ms 376.83ms   79.90%
    Req/Sec     9.20k     1.29k   13.00k    75.45%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    2.01ms
 75.000%  149.12ms
 90.000%  283.90ms
 99.000%  365.05ms
 99.900%  371.97ms
 99.990%  374.78ms
 99.999%  376.58ms
100.000%  377.09ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.046     0.000000            1         1.00
       0.814     0.100000       139475         1.11
       1.078     0.200000       278951         1.25
       1.333     0.300000       418087         1.43
       1.616     0.400000       556868         1.67
       2.009     0.500000       696267         2.00
       2.371     0.550000       765675         2.22
      50.015     0.600000       835301         2.50
      83.263     0.650000       904951         2.86
     119.615     0.700000       974487         3.33
     149.119     0.750000      1044130         4.00
     175.743     0.775000      1079026         4.44
     196.351     0.800000      1113938         5.00
     209.919     0.825000      1148515         5.71
     224.895     0.850000      1183329         6.67
     251.391     0.875000      1218115         8.00
     270.847     0.887500      1235617         8.89
     283.903     0.900000      1252919        10.00
     298.495     0.912500      1270348        11.43
     313.599     0.925000      1287837        13.33
     321.791     0.937500      1305231        16.00
     326.911     0.943750      1314149        17.78
     332.287     0.950000      1322555        20.00
     337.151     0.956250      1331507        22.86
     341.503     0.962500      1340127        26.67
     346.111     0.968750      1348971        32.00
     349.183     0.971875      1353137        35.56
     353.023     0.975000      1357529        40.00
     356.095     0.978125      1361718        45.71
     358.911     0.981250      1366326        53.33
     361.215     0.984375      1370517        64.00
     362.495     0.985938      1372714        71.11
     363.519     0.987500      1374992        80.00
     364.287     0.989062      1376899        91.43
     365.311     0.990625      1379522       106.67
     366.079     0.992188      1381273       128.00
     366.591     0.992969      1382380       142.22
     367.359     0.993750      1383918       160.00
     367.871     0.994531      1384926       182.86
     368.383     0.995313      1386008       213.33
     368.895     0.996094      1387013       256.00
     369.151     0.996484      1387493       284.44
     369.407     0.996875      1387893       320.00
     369.663     0.997266      1388319       365.71
     370.175     0.997656      1389062       426.67
     370.687     0.998047      1389674       512.00
     370.687     0.998242      1389674       568.89
     371.199     0.998437      1390189       640.00
     371.455     0.998633      1390445       731.43
     371.711     0.998828      1390656       853.33
     371.967     0.999023      1390864      1024.00
     372.223     0.999121      1391094      1137.78
     372.223     0.999219      1391094      1280.00
     372.479     0.999316      1391243      1462.86
     372.735     0.999414      1391388      1706.67
     372.991     0.999512      1391495      2048.00
     373.247     0.999561      1391623      2275.56
     373.247     0.999609      1391623      2560.00
     373.503     0.999658      1391706      2925.71
     373.759     0.999707      1391788      3413.33
     373.759     0.999756      1391788      4096.00
     374.015     0.999780      1391846      4551.11
     374.271     0.999805      1391913      5120.00
     374.271     0.999829      1391913      5851.43
     374.527     0.999854      1391937      6826.67
     374.783     0.999878      1391991      8192.00
     374.783     0.999890      1391991      9102.22
     374.783     0.999902      1391991     10240.00
     375.039     0.999915      1392005     11702.86
     375.295     0.999927      1392025     13653.33
     375.551     0.999939      1392047     16384.00
     375.551     0.999945      1392047     18204.44
     375.807     0.999951      1392066     20480.00
     375.807     0.999957      1392066     23405.71
     376.063     0.999963      1392084     27306.67
     376.063     0.999969      1392084     32768.00
     376.063     0.999973      1392084     36408.89
     376.319     0.999976      1392094     40960.00
     376.319     0.999979      1392094     46811.43
     376.319     0.999982      1392094     54613.33
     376.575     0.999985      1392107     65536.00
     376.575     0.999986      1392107     72817.78
     376.575     0.999988      1392107     81920.00
     376.575     0.999989      1392107     93622.86
     376.575     0.999991      1392107    109226.67
     376.831     0.999992      1392114    131072.00
     376.831     0.999993      1392114    145635.56
     376.831     0.999994      1392114    163840.00
     376.831     0.999995      1392114    187245.71
     376.831     0.999995      1392114    218453.33
     376.831     0.999996      1392114    262144.00
     377.087     0.999997      1392119    291271.11
     377.087     1.000000      1392119          inf
#[Mean    =       81.550, StdDeviation   =      114.261]
#[Max     =      376.832, Total count    =      1392119]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  2093645 requests in 30.00s, 133.78MB read
Requests/sec:  69790.55
Transfer/sec:      4.46MB
```

[CPU profile](put_cpu_t8_c64_R70000.html)

- ~20% CPU уходит на работу с потоками (старт, блокировки)
- ~21% на отправку ответа, 4% на бизнес логику
- ~26% на `poll()` очереди
- ~23% на обработку запроса

[Allocation profile](put_alloc_t8_c64_R70000.html)

- ~54% занимает `HttpServer.handleRequest`, из которых ~11% ушло на отправку ответа (`one/nio/http/HttpSession.sendResponse`),
  ~5% на преобразование параметров запроса (`one/nio/http/Request.getRequiedParameter`), ~6% на получение path запроса (`one/nio/http/Request.getPath`),
  ~1% на upsert, ~9% на преобразование строки в MemorySegment
- оставшиеся ~46% занимает `one/nio/server/SelectorThread.run`, из которых ~7% ушло на сам select, остальное ушло на обработку запроса

[Lock profile](put_lock_t8_c64_R70000.html)

- ~88% локов занимает `ArrayBlockingQueue.take`
- ~5% локов занимает `handleRequest`
- ~7% - `one/nio/http/HttpSession.sendResponse`

### GET TEST

Прогон с `64` соединениями и `8` потоками. Показатели начинают ухудшаться примерно при `RPS`, равном `75_000`:

```shell
./wrk -d 30 -t 8 -c 64 -R 75000 -L -s src/main/java/ru/vk/itmo/test/reshetnikovaleksei/lua/get.lua http://localhost:8080                     ok  30s  %  22:33:30 
Running 30s test @ http://localhost:8080
  8 threads and 64 connections
  Thread calibration: mean lat.: 1.395ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.419ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.425ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.416ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.390ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.410ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.392ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.401ms, rate sampling interval: 10ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     9.33ms   26.29ms 169.98ms   93.04%
    Req/Sec     9.81k     0.86k   13.22k    70.68%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    1.64ms
 75.000%    2.57ms
 90.000%   14.61ms
 99.000%  142.21ms
 99.900%  157.95ms
 99.990%  166.65ms
 99.999%  169.47ms
100.000%  170.11ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.048     0.000000            2         1.00
       0.788     0.100000       149093         1.11
       1.015     0.200000       297430         1.25
       1.220     0.300000       446300         1.43
       1.423     0.400000       594515         1.67
       1.642     0.500000       743376         2.00
       1.765     0.550000       817555         2.22
       1.901     0.600000       891403         2.50
       2.063     0.650000       965825         2.86
       2.265     0.700000      1040336         3.33
       2.567     0.750000      1114493         4.00
       2.825     0.775000      1151381         4.44
       3.279     0.800000      1188538         5.00
       4.199     0.825000      1225662         5.71
       5.567     0.850000      1262784         6.67
       8.631     0.875000      1299909         8.00
      10.967     0.887500      1318455         8.89
      14.607     0.900000      1337009        10.00
      18.383     0.912500      1355667        11.43
      28.895     0.925000      1374154        13.33
      50.879     0.937500      1392711        16.00
      60.991     0.943750      1402001        17.78
      69.951     0.950000      1411301        20.00
      81.663     0.956250      1420566        22.86
      88.575     0.962500      1429880        26.67
     101.311     0.968750      1439158        32.00
     109.759     0.971875      1443791        35.56
     117.503     0.975000      1448441        40.00
     126.143     0.978125      1453081        45.71
     129.279     0.981250      1457744        53.33
     132.479     0.984375      1462409        64.00
     135.551     0.985938      1464696        71.11
     138.367     0.987500      1467095        80.00
     140.799     0.989062      1469330        91.43
     142.975     0.990625      1471778       106.67
     144.895     0.992188      1474091       128.00
     145.791     0.992969      1475119       142.22
     146.943     0.993750      1476303       160.00
     148.351     0.994531      1477465       182.86
     150.015     0.995313      1478611       213.33
     151.679     0.996094      1479771       256.00
     152.575     0.996484      1480412       284.44
     153.343     0.996875      1480976       320.00
     154.111     0.997266      1481545       365.71
     154.879     0.997656      1482097       426.67
     155.775     0.998047      1482724       512.00
     156.159     0.998242      1482985       568.89
     156.543     0.998437      1483245       640.00
     157.055     0.998633      1483570       731.43
     157.567     0.998828      1483871       853.33
     158.079     0.999023      1484142      1024.00
     158.463     0.999121      1484279      1137.78
     158.847     0.999219      1484416      1280.00
     159.359     0.999316      1484574      1462.86
     159.871     0.999414      1484698      1706.67
     160.639     0.999512      1484829      2048.00
     161.151     0.999561      1484901      2275.56
     161.919     0.999609      1484977      2560.00
     162.687     0.999658      1485047      2925.71
     163.455     0.999707      1485123      3413.33
     164.223     0.999756      1485191      4096.00
     164.607     0.999780      1485227      4551.11
     164.991     0.999805      1485265      5120.00
     165.503     0.999829      1485308      5851.43
     165.887     0.999854      1485340      6826.67
     166.271     0.999878      1485374      8192.00
     166.527     0.999890      1485397      9102.22
     166.783     0.999902      1485411     10240.00
     167.039     0.999915      1485435     11702.86
     167.295     0.999927      1485446     13653.33
     167.807     0.999939      1485466     16384.00
     167.935     0.999945      1485473     18204.44
     168.191     0.999951      1485484     20480.00
     168.319     0.999957      1485494     23405.71
     168.575     0.999963      1485503     27306.67
     168.703     0.999969      1485509     32768.00
     168.831     0.999973      1485513     36408.89
     168.959     0.999976      1485517     40960.00
     169.087     0.999979      1485522     46811.43
     169.215     0.999982      1485528     54613.33
     169.343     0.999985      1485535     65536.00
     169.343     0.999986      1485535     72817.78
     169.343     0.999988      1485535     81920.00
     169.471     0.999989      1485539     93622.86
     169.599     0.999991      1485542    109226.67
     169.599     0.999992      1485542    131072.00
     169.727     0.999993      1485547    145635.56
     169.727     0.999994      1485547    163840.00
     169.727     0.999995      1485547    187245.71
     169.727     0.999995      1485547    218453.33
     169.855     0.999996      1485548    262144.00
     169.855     0.999997      1485548    291271.11
     169.983     0.999997      1485549    327680.00
     170.111     0.999997      1485553    374491.43
     170.111     1.000000      1485553          inf
#[Mean    =        9.331, StdDeviation   =       26.290]
#[Max     =      169.984, Total count    =      1485553]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  2227953 requests in 30.00s, 158.50MB read
Requests/sec:  74267.65
Transfer/sec:      5.28MB
```

[CPU profile](get_cpu_t8_c64_R75000.html)

- ~21% CPU уходит на работу с потоками (старт, блокировки)
- ~24% на отправку ответа, 6% на бизнес логику
- ~21% на `poll()` очереди
- ~24% на обработку запроса

[Allocation profile](get_alloc_t8_c64_R75000.html)

- ~64% занимает `HttpServer.handleRequest`, из которых ~19% ушло на отправку ответа (`one/nio/http/HttpSession.sendResponse`),
  ~5% на преобразование параметров запроса (`one/nio/http/Request.getRequiedParameter`), ~6% на получение path запроса (`one/nio/http/Request.getPath`), 
  ~6% на чтение значения, ~9% на преобразование строки в MemorySegment
- оставшиеся ~36% занимает `one/nio/server/SelectorThread.run`, из которых ~8% ушло на сам select, остальное ушло на обработку запроса

[Lock profile](get_lock_t8_c64_R75000.html)

- ~87% локов занимает `ArrayBlockingQueue.take`
- ~4% локов занимает `handleRequest`
- ~9% - `one/nio/http/HttpSession.sendResponse`

## Выводы

При выполнении `stage1` ноутбук был достаточно уставшим (непрерывная работа в течение нескольких дней). При выполнении
решил перезапустить ноутбук, благодаря чему удалось получить в разы лучшие результаты `RPS`
