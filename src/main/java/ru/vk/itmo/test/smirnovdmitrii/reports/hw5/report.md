# Отчет HW4

Тестирование wrk проводилось в 4 потока для 16 соединений с `ack=2&from=3`

## PUT

Для `put` запросов точкой разладки было 16к rps (база изначально была пустой)

| percentage  | latency |
|-------------| ----|
| 50.000%  |  1.46ms |
| 75.000%  |  1.99ms |
| 90.000%  |  2.72ms |
| 99.000%  |  4.49ms |
| 99.900%  |  6.49ms |
| 99.990%  |  7.92ms |
| 99.999%  |  8.66ms |
| 100.000%  |  8.86ms |

[график](https://disk.yandex.ru/i/Ayg7t1u3g8AoKg)

[профилирование cpu](https://disk.yandex.ru/d/KCmrwW5bOi9-gg)

[профилирование alloc](https://disk.yandex.ru/d/3YvQmU6zERjAOQ)

[профилирование lock](https://disk.yandex.ru/d/rNXn4J7LL4kZVw)

## GET

При `get` запросах точкой разладки оказалось 17k rpc (база была заполнена на 800 мегабайт на ноду, суммарно 960 тысяч значений)

| percentage | latency |
| ---------- | ------- |
| 50.000% |    1.47ms |
| 75.000% |    2.03ms |
| 90.000% |    2.67ms |
| 99.000% |    4.13ms |
| 99.900% |    6.29ms |
| 99.990% |   14.29ms |
| 99.999% |   17.30ms |
| 100.000% |   17.66ms |

[график](https://disk.yandex.ru/i/oLhmEo2s_s74-g)

[профилирование cpu](https://disk.yandex.ru/d/qGeFGb321YH2RQ)

[профилирование alloc](https://disk.yandex.ru/d/fRJGPqU8zZldVA)

[профилирование lock](https://disk.yandex.ru/d/-2dAsxyVSQVMeQ)


Что изменилось? Если посмотреть на предыдущее профилирование [put](https://disk.yandex.ru/d/Evdm1hsgjZziwA), то можно заметить много отличий.

Исполнение метода, который исполняет логику самой базы занимало 0,89% всего cpu, а теперь это значение 0,4%
При этом само задание воркера исполнялось 35%, а стало исполняться 4%.

При этом суммарно вызовы park на потоках около 35% процента, когда как до этого было около 15 процентов.

Где-то проскочили вызовы `ForkJoinPool`, поэтому, в том числе, ожидание зависело и от этого пула потоков.

Если сравнивать [предыдущий alloc](https://disk.yandex.ru/d/gE_920JbDpDPHQ), то если раньше редиректы занимали почти все аллокации на put (60 процентов всех обращений к TLAB), то теперь они занимают менее 20 процентов.

Если посмотреть почти все аллокации касаются записи и чтения пересланных запросов. Весь этот код выполняется внутри `CopletableFuture` и `HttpClient`

С get c аллокациями ситуация такая же с точностью до процентов.