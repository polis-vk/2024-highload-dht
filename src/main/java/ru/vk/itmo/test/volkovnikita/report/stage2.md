# Нагрузечное тестирование с wrk

## Stage 2


## Параметры 

### ArrayBlockingQueue

В качестве очереди была выбрана ArrayBlockingQueue.
ArrayBlockingQueue обеспечивает более высокую производительность в сценариях с высокой 
загруженостью, благодаря фиксированному размеру массива и 
меньшему количеству операций по изменению ссылок по сравнению с LinkedBlockingQueue.

### THREADS_POOL_SIZE

Был выбран в размере 8, это значение оказалось оптимальным при -с 128 и -t 128

### AbortPolicy

Для отправки ошибки о большом количестве ошибок 

### handleRequest

Ошибки обрабатываются в handleRequest, если это HttpException.class, то выкидываем 400, иначе 500

## PUT

В результате исследования было получено значение RPS: 88000 при -с 128 и -t 128
с более высокми значениями производительность начинает сильно падать, замеры приозводились при RPS c 6000 до 105000 и
-d 10, 30, 60, 120, результаты были сравнимо одинаковые.
В отчёте представленно -d = 10.


wrk -d 10 -c 128 -t 128 -R 88000 -L -s /home/ravenhub/IdeaProjects/2024-highload-dht/src/main/java/ru/vk/itmo/test/volkovnikita/lua/stage1/put.lua http://127.0.0.1:8080
Running 10s test @ http://127.0.0.1:8080
128 threads and 128 connections
Thread Stats   Avg      Stdev     Max   +/- Stdev
Latency     4.17ms    4.94ms  70.85ms   89.10%
Req/Sec       -nan      -nan   0.00      0.00%
Latency Distribution (HdrHistogram - Recorded Latency)
50.000%    2.38ms
75.000%    4.91ms
90.000%    9.60ms
99.000%   24.35ms
99.900%   44.77ms
99.990%   58.53ms
99.999%   64.29ms
100.000%   70.91ms

Detailed Percentile spectrum:
Value   Percentile   TotalCount 1/(1-Percentile)

       0.041     0.000000            2         1.00
       0.918     0.100000        87819         1.11
       1.248     0.200000       175582         1.25
       1.545     0.300000       263217         1.43
       1.898     0.400000       350928         1.67
       2.383     0.500000       438648         2.00
       2.699     0.550000       482494         2.22
       3.081     0.600000       526365         2.50
       3.551     0.650000       570143         2.86
       4.151     0.700000       614060         3.33
       4.915     0.750000       657735         4.00
       5.383     0.775000       679661         4.44
       5.931     0.800000       701613         5.00
       6.583     0.825000       723555         5.71
       7.375     0.850000       745484         6.67
       8.351     0.875000       767436         8.00
       8.935     0.887500       778311         8.89
       9.599     0.900000       789404        10.00
      10.351     0.912500       800238        11.43
      11.247     0.925000       811225        13.33
      12.335     0.937500       822200        16.00
      12.975     0.943750       827648        17.78
      13.711     0.950000       833162        20.00
      14.575     0.956250       838642        22.86
      15.559     0.962500       844107        26.67
      16.735     0.968750       849565        32.00
      17.439     0.971875       852322        35.56
      18.271     0.975000       855070        40.00
      19.167     0.978125       857827        45.71
      20.159     0.981250       860550        53.33
      21.327     0.984375       863271        64.00
      21.999     0.985938       864671        71.11
      22.783     0.987500       866009        80.00
      23.727     0.989062       867398        91.43
      24.767     0.990625       868748       106.67
      26.095     0.992188       870131       128.00
      26.863     0.992969       870804       142.22
      27.791     0.993750       871495       160.00
      28.815     0.994531       872171       182.86
      30.031     0.995313       872865       213.33
      31.519     0.996094       873548       256.00
      32.319     0.996484       873890       284.44
      33.343     0.996875       874233       320.00
      34.527     0.997266       874570       365.71
      35.807     0.997656       874912       426.67
      37.631     0.998047       875254       512.00
      38.751     0.998242       875425       568.89
      39.967     0.998437       875596       640.00
      41.439     0.998633       875769       731.43
      43.135     0.998828       875940       853.33
      45.055     0.999023       876111      1024.00
      46.207     0.999121       876197      1137.78
      47.519     0.999219       876281      1280.00
      48.543     0.999316       876367      1462.86
      49.791     0.999414       876454      1706.67
      51.231     0.999512       876540      2048.00
      51.999     0.999561       876581      2275.56
      52.671     0.999609       876625      2560.00
      53.375     0.999658       876667      2925.71
      54.303     0.999707       876712      3413.33
      55.071     0.999756       876753      4096.00
      55.487     0.999780       876775      4551.11
      55.903     0.999805       876796      5120.00
      56.319     0.999829       876817      5851.43
      57.023     0.999854       876838      6826.67
      57.631     0.999878       876859      8192.00
      58.175     0.999890       876871      9102.22
      58.783     0.999902       876881     10240.00
      59.231     0.999915       876893     11702.86
      59.711     0.999927       876902     13653.33
      60.671     0.999939       876913     16384.00
      60.895     0.999945       876919     18204.44
      61.279     0.999951       876924     20480.00
      61.791     0.999957       876931     23405.71
      62.175     0.999963       876935     27306.67
      62.463     0.999969       876940     32768.00
      62.527     0.999973       876943     36408.89
      62.879     0.999976       876945     40960.00
      63.103     0.999979       876948     46811.43
      63.743     0.999982       876950     54613.33
      63.967     0.999985       876953     65536.00
      64.031     0.999986       876954     72817.78
      64.191     0.999988       876956     81920.00
      64.287     0.999989       876957     93622.86
      64.319     0.999991       876958    109226.67
      65.279     0.999992       876960    131072.00
      65.279     0.999993       876960    145635.56
      66.431     0.999994       876961    163840.00
      67.647     0.999995       876962    187245.71
      67.647     0.999995       876962    218453.33
      68.607     0.999996       876963    262144.00
      68.607     0.999997       876963    291271.11
      69.503     0.999997       876964    327680.00
      69.503     0.999997       876964    374491.43
      69.503     0.999998       876964    436906.67
      70.271     0.999998       876965    524288.00
      70.271     0.999998       876965    582542.22
      70.271     0.999998       876965    655360.00
      70.271     0.999999       876965    748982.86
      70.271     0.999999       876965    873813.33
      70.911     0.999999       876966   1048576.00
      70.911     1.000000       876966          inf
#[Mean    =        4.169, StdDeviation   =        4.936]
#[Max     =       70.848, Total count    =       876966]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
877094 requests in 9.95s, 56.04MB read
Requests/sec:  88121.66
Transfer/sec:      5.63MB

Результаты в сравнение с stage1 лучше, но естественно при запуске -с 1 -t 1
как в первой работе результат хуже из-за новых накладных расходов.


[profile-88000-cpu-put.html](..%2Fdata%2Fstage2%2Fput%2Fprofile-88000-cpu-put.html)

Больше всего времени занимает отправка ответа

[profile-88000-alloc-put.html](..%2Fdata%2Fstage2%2Fput%2Fprofile-88000-alloc-put.html)

Тут же отправка ответа занимает не так много врмени, зато много времени
занимает работа с базой данных и самим запросом

[profile-88000-lock-put.html](..%2Fdata%2Fstage2%2Fput%2Fprofile-88000-lock-put.html)

Много фигурирует ArrayBlockingQueue и ThreadPoolExecutor 

![Histogram_put_88000.png](..%2Fdata%2Fstage2%2Fput%2FHistogram_put_88000.png)


## GET

В результате исследования было получено значение RPS: 80000 при -с 128 и -t 128,
остальное аналогично исследованию в put запросе, за исключением параметра d
в отчёте представленно -d = 30.

wrk -d 30 -c 128 -t 128 -R 80000 -L -s /home/ravenhub/IdeaProjects/2024-highload-dht/src/main/java/ru/vk/itmo/test/volkovnikita/lua/stage1/get.lua http://127.0.0.1:8080
Running 30s test @ http://127.0.0.1:8080
128 threads and 128 connections
Thread Stats   Avg      Stdev     Max   +/- Stdev
Latency     5.11ms    7.58ms  98.69ms   91.14%
Req/Sec   634.49    103.58     1.76k    79.35%
Latency Distribution (HdrHistogram - Recorded Latency)
50.000%    2.42ms
75.000%    5.58ms
90.000%   11.77ms
99.000%   40.99ms
99.900%   70.21ms
99.990%   85.57ms
99.999%   92.74ms
100.000%   98.75ms

Detailed Percentile spectrum:
Value   Percentile   TotalCount 1/(1-Percentile)

       0.045     0.000000            1         1.00
       0.914     0.100000       160235         1.11
       1.229     0.200000       319852         1.25
       1.522     0.300000       479954         1.43
       1.883     0.400000       639618         1.67
       2.421     0.500000       799562         2.00
       2.797     0.550000       879565         2.22
       3.267     0.600000       959572         2.50
       3.847     0.650000      1039297         2.86
       4.595     0.700000      1119359         3.33
       5.579     0.750000      1199439         4.00
       6.199     0.775000      1239368         4.44
       6.931     0.800000      1279276         5.00
       7.791     0.825000      1319161         5.71
       8.823     0.850000      1359142         6.67
      10.111     0.875000      1399218         8.00
      10.871     0.887500      1419021         8.89
      11.767     0.900000      1439162        10.00
      12.807     0.912500      1459019        11.43
      14.111     0.925000      1479075        13.33
      15.791     0.937500      1499000        16.00
      16.847     0.943750      1509059        17.78
      18.095     0.950000      1518953        20.00
      19.583     0.956250      1528961        22.86
      21.423     0.962500      1538948        26.67
      23.743     0.968750      1548956        32.00
      25.135     0.971875      1553927        35.56
      26.783     0.975000      1558939        40.00
      28.687     0.978125      1563932        45.71
      31.007     0.981250      1568915        53.33
      33.727     0.984375      1573919        64.00
      35.391     0.985938      1576425        71.11
      37.311     0.987500      1578940        80.00
      39.551     0.989062      1581424        91.43
      42.015     0.990625      1583938       106.67
      44.703     0.992188      1586412       128.00
      46.175     0.992969      1587649       142.22
      47.807     0.993750      1588902       160.00
      49.631     0.994531      1590161       182.86
      51.583     0.995313      1591408       213.33
      53.919     0.996094      1592655       256.00
      55.327     0.996484      1593287       284.44
      56.767     0.996875      1593898       320.00
      58.335     0.997266      1594525       365.71
      60.191     0.997656      1595144       426.67
      62.687     0.998047      1595774       512.00
      63.967     0.998242      1596082       568.89
      65.311     0.998437      1596393       640.00
      66.751     0.998633      1596705       731.43
      68.607     0.998828      1597022       853.33
      70.399     0.999023      1597329      1024.00
      71.551     0.999121      1597488      1137.78
      72.703     0.999219      1597641      1280.00
      73.983     0.999316      1597798      1462.86
      75.391     0.999414      1597958      1706.67
      76.799     0.999512      1598115      2048.00
      77.631     0.999561      1598188      2275.56
      78.335     0.999609      1598266      2560.00
      79.167     0.999658      1598345      2925.71
      80.319     0.999707      1598424      3413.33
      81.727     0.999756      1598503      4096.00
      82.303     0.999780      1598540      4551.11
      82.815     0.999805      1598580      5120.00
      83.263     0.999829      1598618      5851.43
      83.967     0.999854      1598658      6826.67
      84.799     0.999878      1598698      8192.00
      85.183     0.999890      1598715      9102.22
      85.631     0.999902      1598735     10240.00
      86.143     0.999915      1598754     11702.86
      86.655     0.999927      1598774     13653.33
      87.295     0.999939      1598793     16384.00
      87.679     0.999945      1598804     18204.44
      87.935     0.999951      1598813     20480.00
      88.319     0.999957      1598823     23405.71
      88.703     0.999963      1598833     27306.67
      89.023     0.999969      1598843     32768.00
      89.215     0.999973      1598848     36408.89
      89.407     0.999976      1598851     40960.00
      89.791     0.999979      1598856     46811.43
      90.431     0.999982      1598861     54613.33
      91.007     0.999985      1598866     65536.00
      91.839     0.999986      1598869     72817.78
      92.287     0.999988      1598871     81920.00
      92.735     0.999989      1598874     93622.86
      93.503     0.999991      1598876    109226.67
      93.567     0.999992      1598879    131072.00
      94.015     0.999993      1598881    145635.56
      94.015     0.999994      1598881    163840.00
      94.271     0.999995      1598882    187245.71
      94.719     0.999995      1598883    218453.33
      95.487     0.999996      1598884    262144.00
      96.767     0.999997      1598885    291271.11
      97.599     0.999997      1598886    327680.00
      97.599     0.999997      1598886    374491.43
      98.111     0.999998      1598888    436906.67
      98.111     0.999998      1598888    524288.00
      98.111     0.999998      1598888    582542.22
      98.111     0.999998      1598888    655360.00
      98.111     0.999999      1598888    748982.86
      98.239     0.999999      1598889    873813.33
      98.239     0.999999      1598889   1048576.00
      98.239     0.999999      1598889   1165084.44
      98.239     0.999999      1598889   1310720.00
      98.239     0.999999      1598889   1497965.71
      98.751     0.999999      1598890   1747626.67
      98.751     1.000000      1598890          inf
#[Mean    =        5.115, StdDeviation   =        7.583]
#[Max     =       98.688, Total count    =      1598890]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
2398663 requests in 29.97s, 180.25MB read
Requests/sec:  80031.68
Transfer/sec:      6.01MB

[profile-80000-cpu-get.html](..%2Fdata%2Fstage2%2Fget%2Fprofile-80000-cpu-get.html)


[profile-80000-alloc-get.html](..%2Fdata%2Fstage2%2Fget%2Fprofile-80000-alloc-get.html)


[profile-80000-lock-get.html](..%2Fdata%2Fstage2%2Fget%2Fprofile-80000-lock-get.html)

Больше всего ресурсов уходит на обработку ответа в handleRequest -> process

![Histogram_80000_get.png](..%2Fdata%2Fstage2%2Fget%2FHistogram_80000_get.png)






